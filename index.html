<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>life-extension&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="chaser of light">
<meta property="og:type" content="website">
<meta property="og:title" content="life-extension&#39;s blogs">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="life-extension&#39;s blogs">
<meta property="og:description" content="chaser of light">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="life-extension">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="life-extension&#39;s blogs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">life-extension&#39;s blogs</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">chaser of light</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-基于门限方案的条形码保密及容错技术" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/30/%E5%9F%BA%E4%BA%8E%E9%97%A8%E9%99%90%E6%96%B9%E6%A1%88%E7%9A%84%E6%9D%A1%E5%BD%A2%E7%A0%81%E4%BF%9D%E5%AF%86%E5%8F%8A%E5%AE%B9%E9%94%99%E6%8A%80%E6%9C%AF/" class="article-date">
  <time datetime="2020-04-30T15:28:27.000Z" itemprop="datePublished">2020-04-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/30/%E5%9F%BA%E4%BA%8E%E9%97%A8%E9%99%90%E6%96%B9%E6%A1%88%E7%9A%84%E6%9D%A1%E5%BD%A2%E7%A0%81%E4%BF%9D%E5%AF%86%E5%8F%8A%E5%AE%B9%E9%94%99%E6%8A%80%E6%9C%AF/">基于门限方案的条形码保密及容错技术</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>经历过初期两个小项目的探索，我们项目团队积累了一定的项目研究经验，在老师和16级学长的帮助下，我们把研究方向转到了门限方案的实际应用上。结合市面上用9张合并的条形码提高条形码的容错能力的操作，我们在保留一定的容错能力的基础上提高条形码的安全性，具体而言就是条形码的保密性和容错能力。</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>依托于信息技术和电子商务的发展，条码技术，作为当今十分流行的一种自动识别与数据采集技术，在商品流通领域被广泛应用。但是在身份识别等应用场景下，传统的条形码不仅易被他人伪造，而且容易导致信息泄露；在恶劣的生产环境中，传统的条形码极有可能因污染损坏导致误读甚至无法识别；此外，常有因传统条形码被覆盖、遮挡或内装物品的安放而造成的条形码弯曲，扫描器无法识别的情况。因此，传统条形码的保密性显得不足，可靠性受到考验。人们急需冗余度高且具有保密能力的条形码，以及在此基础上的自动化扫码系统的大规模使用。</p>
<h3 id="主要问题"><a href="#主要问题" class="headerlink" title="主要问题"></a>主要问题</h3><p>目前传统的一维条形码的使用范围依然很广。 一维条形码的应用可以提高信息录入的速度，减少差错率，而且标签简单实用易于制作，成本几乎为零。但是一维码的设计从未考虑到保密性和防伪造的问题，以至于所有的消息用手机一扫就明文可见，并且输入同样的明文就可以产生相同的条形码。而且，对于所有条形码而言，冗余度低，破损后无法识别的问题普遍存在。</p>
<p>同时，几乎所有的条形码都面临一个问题——冗余度为0，破损或污染以后即无法识别。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>针对传统一维条形码中存在的冗余度的问题，一些企业把条码重复拼接，以提高条形码的冗余度。这种做法的确大大的提高了条形码的冗余度和可靠性，值得肯定。但是在条码无一例外的重复的同时，我们是否能做一件手到拈来的事情呢？我们可以通过在重复的条形码中加入一些门限方案以及验证条形码，在保证条码可靠性的基础上，顺势达到保密性和防伪造的作用。</p>
<p>为解决以上问题，本团队结合 shamir 门限方案与信息隐藏技术，在保障信息安全的基础上提出了基于门限方案的条形码容错与保密技术，旨在解决破损条形码无法扫描识别与传统条形码保密性差、易被伪造等信息安全问题，并且设计制作了一整套生成高保密新型条形码、读码的客户端软件——SaferBar。</p>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>本方案依托操作简易的手机APP——SaferBar，可以根据客户需求将传统条形码转换成不同冗余度的门限条形码，极大地提高了条形码的容错率与保密性。另外，我们在原有明文的基础上拼接条形码的认证密钥，以达到防止伪造的效果。而且，基于图像识别技术，它同时采集处理多个条形码信息，并同时识别含多个子条形码的新型条形码，提高扫码效率，实现传统条形码与新型条形码的无缝衔接，极大程度地提高了条形码的容错率，防止了信息泄露和信息伪造，保障了商品财产及信息安全。具体流程如下：</p>
<h4 id="生成认证密钥"><a href="#生成认证密钥" class="headerlink" title="生成认证密钥"></a>生成认证密钥</h4><p>APP为每一类商品都设置一个随机生成的认证密钥key，并上传存储在数据库中。通过字符串拼接在原有明文的基础上拼接条形码的认证密钥，以达到防止伪造的效果。解密的时候需要验证key的值是否正确，只有当key值正确时才连接数据库获取商品信息。  </p>
<h4 id="编码与加密"><a href="#编码与加密" class="headerlink" title="编码与加密"></a>编码与加密</h4><p>编码环节需要从多方面考虑来确定，如实际的信息量、所选条码的码数限制， 所载信息的可靠性与冗余量的相互取舍关系等。</p>
<p>在条形码选择上，采用 CODE 39 码。这是一种双向扫描的非定长码，即条形码字符个数不是固定的，编码信息可以是数字也可以是大写英文字母码并自带校验码。条形码由九条不同的排列线条编码而得。基于信息冗余提高数据可靠性的思想，每段条形码的最后一位均附带上此条形码的校验位。</p>
<p>生成门限条形码时，初始密钥x为原始的条形码编号。子密钥公式为：</p>
<p>f (x)=m+a<sub>1</sub>x+a<sub>2</sub>x<sub>2</sub>+…+a<sub>k-1</sub>x<sub>k-1</sub> mod p</p>
<p>以（5,9）型条形码为例：</p>
<p>由（5,9）门限方案可知要将条形码分割成由九块条形码组成的门限条形码，n=9。<br>扫描时只要扫描出5块完整内容就可能得到完整的数据，即门限值k=5。<br>把编码 x 代入，依次可算出8个门限值yi=f(i),i=1<del>9；利用条形码换算公式，将 y1</del> y9 换算成对应的条形码，形成由九部分组成的门限条形码。如图：</p>
<p><img src="/2020/04/30/%E5%9F%BA%E4%BA%8E%E9%97%A8%E9%99%90%E6%96%B9%E6%A1%88%E7%9A%84%E6%9D%A1%E5%BD%A2%E7%A0%81%E4%BF%9D%E5%AF%86%E5%8F%8A%E5%AE%B9%E9%94%99%E6%8A%80%E6%9C%AF/image-20200430220542949.png" alt="image-20200430220542949"></p>
<h4 id="译码环节"><a href="#译码环节" class="headerlink" title="译码环节"></a>译码环节</h4><p>机器扫描门限条形码的过程中，将未被损坏的部分子条形码识别出来，将这些门限值y<sub>i </sub>代入拉格朗日，根据Shamir 的门限秘密共享方案的性质可知，最终一定能得出拼接后的条形码 x，其中包括商品编号以及认证密钥。  </p>
<h4 id="服务器验证与商品信息显示"><a href="#服务器验证与商品信息显示" class="headerlink" title="服务器验证与商品信息显示"></a>服务器验证与商品信息显示</h4><p>在拼接后的条形码中获取认证密钥，发送到后端进行校验。服务器中数据库存储格式如下：</p>
<p><img src="/2020/04/30/%E5%9F%BA%E4%BA%8E%E9%97%A8%E9%99%90%E6%96%B9%E6%A1%88%E7%9A%84%E6%9D%A1%E5%BD%A2%E7%A0%81%E4%BF%9D%E5%AF%86%E5%8F%8A%E5%AE%B9%E9%94%99%E6%8A%80%E6%9C%AF/image-20200430224443914.png" alt="image-20200430224443914"></p>
<p>若校验成功，则连接数据库获取商品信息。</p>
<p><img src="/2020/04/30/%E5%9F%BA%E4%BA%8E%E9%97%A8%E9%99%90%E6%96%B9%E6%A1%88%E7%9A%84%E6%9D%A1%E5%BD%A2%E7%A0%81%E4%BF%9D%E5%AF%86%E5%8F%8A%E5%AE%B9%E9%94%99%E6%8A%80%E6%9C%AF/image-20200430224501556.png" alt="image-20200430224501556"></p>
<h3 id="项目的意义"><a href="#项目的意义" class="headerlink" title="项目的意义"></a>项目的意义</h3><p>项目创新性的提出了基于门限方案的条形码保密及容错方案，推出了一款集保密，防伪造，防污损等功能于一体的新型一维条形码。有以下几项重大意义：</p>
<p>1.解决了一维条形码没有任何保密性和冗余度的现状。</p>
<p>2.使得一维条形码可以在身份认证等应用场景流通。</p>
<p>3.只需其中若干子条形码完整,即可可靠识别出原条形码的信息。</p>
<p>4.可以一次性识别出多条条形码信息,即可一次识别出门限条形码,更加快捷。</p>
<p>5.推广价值。本方案不仅限于条形码,还可用于其他相似领域,如二维码。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/30/%E5%9F%BA%E4%BA%8E%E9%97%A8%E9%99%90%E6%96%B9%E6%A1%88%E7%9A%84%E6%9D%A1%E5%BD%A2%E7%A0%81%E4%BF%9D%E5%AF%86%E5%8F%8A%E5%AE%B9%E9%94%99%E6%8A%80%E6%9C%AF/" data-id="ck9odqwkg000apguc0720flr7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/project/" rel="tag">project</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-多媒体第三次选做实验-图像处理、滤波以及动画效果" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/" class="article-date">
  <time datetime="2020-04-23T13:15:30.000Z" itemprop="datePublished">2020-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/">多媒体第三次选做实验-图像处理、滤波以及动画效果</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>粗略看了一下要补充的代码，涉及的功能挺多跨度挺广，但是各个功能是相互独立的，所以即使不完成所有的功能，只要不运行相关代码，程序也不会报错。我决定一个一个来，完成后直接测试功能。</p>
<h3 id="计算灰度值"><a href="#计算灰度值" class="headerlink" title="计算灰度值"></a>计算灰度值</h3><p>计算灰度值的公式在PPT上，对照代码中已经获取了B,G,R的值，只需要保留灰度系数进行运算，注意顺序是B-G-R。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////                   请补充代码-- 计算灰度值，并设置像素的每个通道值为该灰度值</span></span><br><span class="line">                      </span><br><span class="line">                <span class="comment">//////////////  开始补充   ///////////////</span></span><br><span class="line">				gray = B * <span class="number">0.114</span> + G * <span class="number">0.587</span> + R * <span class="number">0.299</span>;</span><br><span class="line">				*(pD + offset) = gray;</span><br><span class="line">				*(pD + offset + <span class="number">1</span>) = gray;</span><br><span class="line">				*(pD + offset + <span class="number">2</span>) = gray;</span><br><span class="line">                <span class="comment">//////////////  结束补充   ///////////////</span></span><br></pre></td></tr></table></figure>

<p>测试效果过关：</p>
<p><img src="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/image-20200423213240919.png" alt="image-20200423213240919"></p>
<h3 id="提取水平向边缘和竖直向边缘"><a href="#提取水平向边缘和竖直向边缘" class="headerlink" title="提取水平向边缘和竖直向边缘"></a>提取水平向边缘和竖直向边缘</h3><p>水平向边缘的提取是一个卷积运算，而今天所学的好几项功能都需要用到卷积运算。此刻我希望的就是能有一个函数能帮我进行矩阵操作。搜了一下“卷积”，没有找到内容，正当我准备自己写这个函数的时候，我看到代码有提示，直接调用FilterBmp。</p>
<p>浏览了一下FilterBmp的功能和参数，第一个参数是卷积核，第二个和第三个参数是bmp图像，不同的是第二个参数句柄是初始图像的，不用进行修改，而第三个参数需要修改。参考一下其他对FilterBmp的调用形式，我们发现bmp_ori_copy和bmp变量可以利用。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FilterBmp(smooth_kernel, bmp_ori_copy, bmp);</span><br></pre></td></tr></table></figure>

<p>记录一下水平向矩阵和竖直向矩阵的名字，xEdge_kernel和yEdge_kernel，所以补充好代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////           请补充代码-- 提取水平向边缘，提示：调用FilterBmp</span></span><br><span class="line">               <span class="comment">//////////////  开始补充   ///////////////</span></span><br><span class="line">			FilterBmp(xEdge_kernel, bmp_ori_copy, bmp);</span><br><span class="line">               <span class="comment">//////////////  结束补充   ///////////////</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////           请补充代码-- 提取竖直向边缘，提示：调用FilterBmp</span></span><br><span class="line">                <span class="comment">//////////////  开始补充   ///////////////</span></span><br><span class="line">				FilterBmp(yEdge_kernel, bmp_ori_copy, bmp);</span><br><span class="line">                <span class="comment">//////////////  结束补充   ///////////////</span></span><br></pre></td></tr></table></figure>

<p>运行结果是成功的，图像中的边缘被成功提取了出来。</p>
<p>水平边缘图：</p>
<p><img src="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/image-20200423214936625.png" alt="image-20200423214936625"></p>
<p>竖直边缘图：</p>
<p><img src="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/image-20200423215015872.png" alt="image-20200423215015872"></p>
<h3 id="实现图像锐化"><a href="#实现图像锐化" class="headerlink" title="实现图像锐化"></a>实现图像锐化</h3><p>这一次提前看到了提示，与IDM_EDGE中的代码有关。IDM_EDGE中实现的功能就是整体边缘提取，边缘图 = 原图 – 模糊图像。而图像锐化的概念是锐化图 = 原图 + 边缘图。所以我们可以得到整体边缘图，再加上原图即可。此刻希望有一个相加函数，就像SubIm1FromIm2一样，结果在函数声明看到了AddIm1ToIm2。实现也就比较简单了。不过在实现前又看到了上面老师注释的一段代码，决定试一试。</p>
<p><img src="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/image-20200423220001751.png" alt="image-20200423220001751"></p>
<p>效果还不错，具体看到实现以后，我明白了，原来这幅图是这样实现的：认为总体边缘图=水平边缘图+竖直边缘图，那么锐化图=原图+水平边缘图+竖直边缘图。但是这么实现的<strong>不足之处</strong>就是，代码 AddIm1ToIm2(bmp_ori_copy, bmp)会改变bmp_ori_copy的值，会影响到后面的操作。</p>
<p>那么我自己的实现就只能按照PPT的形式了，先给出代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////           请补充代码-- 实现图像锐化，提示：与IDM_EDGE中的代码有关</span></span><br><span class="line">               <span class="comment">//////////////  开始补充   ///////////////</span></span><br><span class="line">			FilterBmp(smooth_kernel, bmp_ori_copy, bmp);</span><br><span class="line">			SubIm1FromIm2(bmp, bmp_ori_copy);</span><br><span class="line">			AddIm1ToIm2(bmp_ori_copy, bmp);</span><br><span class="line">               <span class="comment">//////////////  结束补充   ///////////////</span></span><br></pre></td></tr></table></figure>

<p>再看看效果如何：</p>
<p>不算很明显，不知道有没有成功，这是锐化后的：</p>
<p><img src="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/image-20200423220822623.png" alt="image-20200423220822623"></p>
<p>我反而觉得锐化前更清晰一些。</p>
<p><img src="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/image-20200423221301931.png" alt="image-20200423221301931"></p>
<h3 id="判断鼠标位置并设置对应像素"><a href="#判断鼠标位置并设置对应像素" class="headerlink" title="判断鼠标位置并设置对应像素"></a>判断鼠标位置并设置对应像素</h3><p>判断鼠标位置是否在图像内，我们知道图像的长宽，又知道图像没有偏移，起点在（0,0）。因此可以直接判断，这部分代码可以应用老师在FilterBmp的一段代码，但是为了让代码不那么啰嗦，我还是自己写了。另外设置像素值的事情让我想到了保留红色通道。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////           请补充代码--实现：判断鼠标位置是否在图像内，并设置对应像素为红色</span></span><br><span class="line">            <span class="comment">//////////////  开始补充   ///////////////</span></span><br><span class="line">			<span class="keyword">if</span> (y &gt;= <span class="number">0</span> &amp;&amp; y &lt; bmp.bmHeight &amp;&amp; x &gt;= <span class="number">0</span> &amp;&amp; x &lt; bmp.bmWidth)</span><br><span class="line">			<span class="comment">//在图像内</span></span><br><span class="line">			&#123;</span><br><span class="line">				BYTE* pD = (BYTE*)bmp.bmBits;</span><br><span class="line">				<span class="keyword">int</span> i = y * bmp.bmWidth + x;</span><br><span class="line">				<span class="keyword">long</span> offset = i * <span class="number">4</span>;</span><br><span class="line">				*(pD + offset) = <span class="number">0</span>;</span><br><span class="line">				*(pD + offset + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">				*(pD + offset + <span class="number">2</span>) = *(pD + offset + <span class="number">2</span>); <span class="comment">//红色通道</span></span><br><span class="line">				*(pD + offset + <span class="number">3</span>) = <span class="number">0</span>; <span class="comment">//这是透明度通道</span></span><br><span class="line">				InvalidateRect(hWnd, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br><span class="line">			&#125;        </span><br><span class="line">            <span class="comment">//////////////  结束补充   ///////////////</span></span><br></pre></td></tr></table></figure>

<p>运行的结果就是，能画线，但是位置真好反了过来，就像倒立了一样，所以这个offset抓的是有问题的。</p>
<p>把</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = y * bmp.bmWidth + x;</span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = (bmp.bmHeight-y) * bmp.bmWidth + x;</span><br></pre></td></tr></table></figure>

<p>这样一来就解决了问题。</p>
<p><img src="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/image-20200423225138987.png" alt="image-20200423225138987"></p>
<h3 id="与硬件无关的动画速度"><a href="#与硬件无关的动画速度" class="headerlink" title="与硬件无关的动画速度"></a>与硬件无关的动画速度</h3><p>根据PPT的内容，首先找到代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preTime = GetTickCount();</span><br></pre></td></tr></table></figure>

<p>这个就是记录当前时间的方法，然后按照PPT上面基本可以补充好如下代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////      请补充代码-- 实现与机器速度无关的平移</span></span><br><span class="line">   <span class="comment">///         要求实现x = x + animSpeed * deltaTime，其中deltaTime是本次与上次运行之间的时间差</span></span><br><span class="line">   <span class="comment">//////////////  开始补充   ///////////////</span></span><br><span class="line">now = GetTickCount();</span><br><span class="line">deltaTime = now - preTime;</span><br><span class="line">preTime = now;</span><br><span class="line">x = x + animSpeed * deltaTime;</span><br><span class="line">   <span class="comment">//////////////  结束补充   ///////////////</span></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<p><img src="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/image-20200423225822497.png" alt="image-20200423225822497"></p>
<p>运行成功，点住消息栏不放，小方块不会动，但一旦松开，程序将重新计算deltatime，所以小方块一般会出现较大的位移。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/" data-id="ck9odqwki000bpguc6tkyh3hl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/study/" rel="tag">study</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-基于win32-GDI的图像显示方法选做实验笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/17/%E5%9F%BA%E4%BA%8Ewin32-GDI%E7%9A%84%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%B3%95%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2020-04-17T03:56:26.000Z" itemprop="datePublished">2020-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/17/%E5%9F%BA%E4%BA%8Ewin32-GDI%E7%9A%84%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%B3%95%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/">基于win32 GDI的图像显示方法选做实验笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这是多媒体原理的第二次选做实验，这次为了充分调动自己的主观能动性，我打算自己先写好代码运行程序，然后再去评论区了解到其他同学对待这个问题的思考角度。</p>
<h3 id="程序代码与注释"><a href="#程序代码与注释" class="headerlink" title="程序代码与注释"></a>程序代码与注释</h3><h5 id="任务一：修改画布内容，只显示G通道"><a href="#任务一：修改画布内容，只显示G通道" class="headerlink" title="任务一：修改画布内容，只显示G通道"></a>任务一：修改画布内容，只显示G通道</h5><p>这段代码其实是老师在视频中重点讲解演示过的，不过当时的对象是红色通道。视频中提醒我需要注意的点：BMP中每个像素的存储点是按B-G-R顺序来进行的。我们的目标是对于每个像素点，对画布图片的指针进行操作，只保留绿色通道的值，其他都清零，于是可以补充代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> offset = i * <span class="number">4</span>;</span><br><span class="line">*(pD + offset) = <span class="number">0</span>;</span><br><span class="line">*(pD + offset + <span class="number">1</span>) = *(pD + offset + <span class="number">1</span>);<span class="comment">//绿色通道</span></span><br><span class="line">*(pD + offset + <span class="number">2</span>) = <span class="number">0</span>; </span><br><span class="line">*(pD + offset + <span class="number">3</span>) = <span class="number">0</span>; <span class="comment">//这是透明度通道</span></span><br></pre></td></tr></table></figure>

<p>但是我觉得这段代码也存在一些问题。比如我们这里，需要保留G通道的值，所以修改G通道的值的代码貌似是多余的，其他两个通道也是，都有一句代码是多余的，虽然这样更易读，但我还是决定删掉，最终通过测试的一部分代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">              <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; nP; i++)</span><br><span class="line">              &#123;</span><br><span class="line">                 </span><br><span class="line">                 <span class="comment">//请补充代码--保留G通道的值，把R和B通道值置零</span></span><br><span class="line">                 </span><br><span class="line">                  <span class="comment">//////////////  开始补充   ///////////////</span></span><br><span class="line"><span class="keyword">long</span> offset = i * <span class="number">4</span>;</span><br><span class="line">*(pD + offset) = <span class="number">0</span>;</span><br><span class="line">*(pD + offset + <span class="number">2</span>) = <span class="number">0</span>; </span><br><span class="line">*(pD + offset + <span class="number">3</span>) = <span class="number">0</span>; <span class="comment">//这是透明度通道</span></span><br><span class="line">                  <span class="comment">//////////////  结束补充   ///////////////</span></span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure>

<p>测试效果也是OK的。</p>
<p><img src="/2020/04/17/%E5%9F%BA%E4%BA%8Ewin32-GDI%E7%9A%84%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%B3%95%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/image-20200417123354912.png" alt="image-20200417123354912"></p>
<h5 id="任务二：倒立图像"><a href="#任务二：倒立图像" class="headerlink" title="任务二：倒立图像"></a>任务二：倒立图像</h5><p>在写代码之前，我思考了老师在代码中注释的一个问题，在这段代码中为什么halfline–：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> halfLines = bmp.bmHeight / <span class="number">2</span>;</span><br><span class="line">               <span class="keyword">if</span> (halfLines * <span class="number">2</span> &gt; bmp.bmHeight)</span><br><span class="line">                   halfLines--; <span class="comment">//为什么要进行这个计算？</span></span><br></pre></td></tr></table></figure>

<p>这段代码是为了找出图片翻转循环的执行次数。在代码上其实还有其他的表示方法，总体的目标就是找到中间行，使得除了中间行（如果存在的话）之外图像收尾对应行的交换，最终实现图像倒立。中间行是不必参与交换的。举个例子，如果图像有10行，从0开始数，那么第4行和第5行需要交换。如果图像有11行，那么第5行固定不动即可。</p>
<p>补充的代码要求将第i行的像素值与垂直方向对应行像素值进行互换，那么按照上面10行的例子，就是第0行和第9行换，halflines是5，推广起来就是第i行和第halflines*2-1-i行换。具体的做法和两个值的交换函数没有区别，可补充代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">               <span class="comment">//请补充代码--将第i行的像素值与垂直方向对应行像素值进行互换</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">//////////////  开始补充   ///////////////</span></span><br><span class="line">*(pD + i * bmp.bmWidthBytes + j) =  *(pD + (halfLines * <span class="number">2</span> - <span class="number">1</span> - i) * bmp.bmWidthBytes + j);</span><br><span class="line">*(pD + (halfLines * <span class="number">2</span> - <span class="number">1</span> - i) * bmp.bmWidthBytes + j) = midV;</span><br><span class="line"></span><br><span class="line">               <span class="comment">//////////////  结束补充   ///////////////</span></span><br></pre></td></tr></table></figure>

<p>成功完成任务：</p>
<p><img src="/2020/04/17/%E5%9F%BA%E4%BA%8Ewin32-GDI%E7%9A%84%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%B3%95%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/image-20200417130122809.png" alt="image-20200417130122809"></p>
<h3 id="讨论与交流"><a href="#讨论与交流" class="headerlink" title="讨论与交流"></a>讨论与交流</h3><p>上传任务后，我又去讨论区看了看其他同学的成果。他们大多提到了一个问题，那就是式子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">halfLines * <span class="number">2</span> &gt; bmp.bmHeight</span><br></pre></td></tr></table></figure>

<p>是一条永真式。我们讨论了一番，最后还是打算求助老师。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/17/%E5%9F%BA%E4%BA%8Ewin32-GDI%E7%9A%84%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%B3%95%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/" data-id="ck9odqwkd0008pgucamh4fbep" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/study/" rel="tag">study</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-基于CRT的物流信息安全处理方案" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/15/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E7%89%A9%E6%B5%81%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/" class="article-date">
  <time datetime="2020-04-15T14:38:05.000Z" itemprop="datePublished">2020-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/15/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E7%89%A9%E6%B5%81%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/">基于CRT的物流信息安全处理方案</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在2018年11月份的时候，段老师在密码学课上讲到了密钥分发协议，我当时就觉得这个协议很有意思也很有应用前景。后来老师还很主动地分享了一下它的idea，其中一部分就是有关物流单上的信息安全问题的。这个我深有感触，其实每次处理快递的时候，我都会把快递单撕得粉碎，然后倒进垃圾桶。但是物流过程中的信息泄露的确更让人担心。</p>
<p>老师向我们提出了她的愿景：通过洋葱路由或者密钥分发技术加密快递单上的消息，使得快递在配送的过程中只知道它的上一站和下一站。于是我搭档了两位学习很认真的女同学，打算对基于CRT的物流信息安全处理方案一探究竟。</p>
<h3 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h3><p>基于CRT的理论知识，我们采用二维码技术以及密钥分发技术，提出了一种物流过程信息安全处理方法。这种方法的实施过程如下（设寄件人为p，收件人为q，先后经过快递驿站或快递员A,B,C,D）：</p>
<ol>
<li><p><strong>寄件人p通过app填上寄件驿站代号（A）,收件人q的地址、姓名以及app号。</strong></p>
</li>
<li><p><strong>app终端立即自动生成快递单号以及最短路径，并分割形成相应密文。</strong></p>
<pre><code>App根据寄件驿站与目的地，用迪杰斯特拉算法生成最短路径(p-A-B-C-D-q)，并告知q寄件人的相关信息。然后把路径中除了初始驿站的每一个结点分割出来(B/C/D/收件人姓名和地址)，并一次对每一个文件随机产生一次性密钥(Ks1, Ks2, Ks3, Ks4)，并用AES算法进行加密（生成密文c1,c2,c3,c4）</code></pre></li>
<li><p><strong>同时，生成通过中转站私钥生成随机数R，使该站只能解密其下一个站点的信息。</strong></p>
<pre><code>  若中转站的私钥为（Ka,Kb,Kc,Kd）：
（1）A知道下一个地址是B，那么我们可以构造R1使得下列方程组成立:
    R1=Ks1(mod Ka)
    R1=0(mod Kb)
    R1=0(mod Kc)
    R1=0(mod Kd)
（2）B知道下一个地址是C，那么我们可以构造R2使得下列方程组成立:
    R2=0(mod Ka)
    R2=Ks2(mod Kb)
    R2=0(mod Kc)
    R2=0(mod Kd)
（3）C知道下一个地址是D，那么我们可以构造R3使得下列方程组成立:
    R3=0(mod Ka)
    R3=0(mod Kb)
    R3=Ks3(mod Kc)
    R3=0(mod Kd)
（4）D知道下一个地址最终是用户q，那么我们可以构造R4下列方程组成立:
    R4=0(mod Ka)
    R4=0(mod Kb)
    R4=0 (mod Kc)
    R4= Ks4(mod Kd)</code></pre></li>
<li><p><strong>用二维码对所有密文（c1,c2,c3,c4）与随机数(R1,R2,R3,R4)以及快递单号进行封装</strong>。</p>
</li>
<li><p><strong>寄件。</strong></p>
<p>​       p到A驿站寄件时出示快递单号，系统就会自动把二维码打印出来，由工作人员贴在快递上。同时终端删除路径信息，只留下快递单号和收件人的app号。A驿站派件时，只需要扫描一下二维码查看下一个站点，此时终端自动通过快递号给收件人q发送一条“快递已经在A寄出，下一站是B” 的消息。</p>
</li>
<li><p><strong>中转。</strong></p>
<p>​       到达中转站时，分发人员只需要扫描一下二维码，就可以得到该包裹下一站的信息，但是却得不到其他任何信息。同时通过终端给收件人q发送一条“快递已经到达中转站xx（B/C），下一站是xx（C/D）”的信息</p>
</li>
<li><p><strong>到达。</strong></p>
<p>​       到达最后一个中转站D时，由于扫出的信息带有用户姓名，app自动给用户发送一条“请到D驿站取快递，取件码xxx（随机生成）”的消息。</p>
</li>
<li><p><strong>接收。</strong></p>
<p>​       用户取快递时，只需要通过取件码和姓名取快递即可。若为贵重物品，则只需要拿出app通过快递号验证即可。</p>
</li>
</ol>
<h3 id="优点分析"><a href="#优点分析" class="headerlink" title="优点分析"></a>优点分析</h3><p><strong>1.AES算法极大的简化了加密解密的时间，而且安全性也相对较好，资源消耗也较少。</strong></p>
<p><strong>2.基于CRT的密钥分发协议，简单易实现，而且计算代价为常数阶。</strong></p>
<p><strong>3.通过加密和密钥分发能充分达到保护用户隐私的要求。</strong><br>       由于通过二维码只可以得知快递单号，其余均是密文，不法分子无法从中得到任何有用的信息，所以用户大可抛弃快递单。<br>       不仅如此，对各中转站而言，他们也无法从中得到任何有用的信息，因为他们只知道快递的下一个中转站。而对于最后一站，他们尽管可以知道用户在app中的ID和姓名，但是没有电话号码，所以作用也不大。<br><strong>4.用户能够了解物流寄出与派送情况</strong><br>       用户可以通过app发出的消息，先后知道寄件人的信息，快递已经到达的中转站及其下一站，最后知道取件码等信息。所以出现问题也可以问责相关的物流站点。</p>
<h3 id="讨论与质疑"><a href="#讨论与质疑" class="headerlink" title="讨论与质疑"></a>讨论与质疑</h3><p>我们小组在项目实施过程中，对项目的应用前景提出了如下质疑：</p>
<p>1.流程中存在的漏洞：</p>
<p>​       在设计流程中，我们先让寄件人选择好寄件地址和收件地址，并由算法确定接下来邮件的路径，但这样可能会存在一些非预期问题。如果寄件人说好在A驿站寄件却去了其他驿站，是拒绝派送还是新生成一张存储A驿站信息的二维码，方法有待商榷。另外如果由于工作或者其他原因邮件被寄到了某个不在路径之内的中转站，又应该怎么处理？</p>
<p>2.密钥更新有关问题：</p>
<p>​       分析对中转站密钥穷举攻击的可能性，以及中转站是否需要更换密钥，多久更换密钥。</p>
<p>3.成本与性价比问题：</p>
<p>​       需要分析二维码加密和识别工具的制作成本以及攻击者的攻击成本和可能导致的信息泄露后果，以及加密对快递拣发效率的影响。以确定该方案的性价比是否足够的好。</p>
<h3 id="总结与感想"><a href="#总结与感想" class="headerlink" title="总结与感想"></a>总结与感想</h3><p>电子商务的快速发展使得个人信息的泄露问题已经成为公众生活的威胁之一，针对不法快递人员将快递信息用以市场交易，甚至直接威胁收件人、寄件人的生命财产安全，文章提出利用二维码技术与计算机技术相结合，基于二维码技术，采用分层加密技术，对物流信息进行分层加密后转储到二维码进行二次封装，并且不同等级授权机制解密相关信息，保护信息安全。</p>
<p>但是流程中存在某些漏洞，实际应用中可能带来比较大的麻烦，性价比方面还需要调查研究。所以这个项目有待优化。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/15/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E7%89%A9%E6%B5%81%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/" data-id="ck9odqwk40006pgucg7dr0m42" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/project/" rel="tag">project</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-基于CRT的新型群文件共享系统" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time datetime="2020-04-13T13:45:15.000Z" itemprop="datePublished">2020-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/">基于CRT的新型群文件共享系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这个项目的是在2019年寒假期间进行的，4月份在中南大学信息安全作品赛答辩，但是由于功能只实现了主体部分，加之我在台上比较胆怯紧张，所以只获得团队三等奖，但是当时老师们还是对我们鼓励有加，说我们有实实在在在做项目。在此感谢两位搭档与我一起努力，共克难关。看着当时做的答辩PPT和项目代码，依然觉得感受良多。这的确是一次既有收获又有遗憾的项目经历。</p>
<h4 id="选题背景"><a href="#选题背景" class="headerlink" title="选题背景"></a>选题背景</h4><p>在密码学课程中，我们的指导老师段老师给了我们很多新颖的idea。其中一条是和群文件分级管理有关的，她分析了一个现象：目前在比较大的QQ群里，往往存在很严重的信息泄露情况。如果我们能在聊天群里面对文件进行分级管理，会不会有更好的效果？</p>
<p>的确，信息泄露现象已经屡见不鲜，前不久在学校举办的天梯赛里面就出现了这样的问题，<strong>组委会在公布参赛人员名单的时候竟然把所有参与者的姓名，学院，专业名称，班级，学号，QQ，邮箱和联系电话等资料统统泄露了出来，其中也包括我的资料。</strong>我对此感到不满，立即与发布这份名单的同学说清楚这样发布名单的危险。还好她很快认识到自己在隐私保护方面的不足，两三分钟后迅速地把这份报名表撤回了。</p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/1.png" alt="被泄露的报名表"></p>
<p>虽然一份名单中的信息量不多，对不法分子而言可能还卖不出一份好价钱。但是如果人人都抱着这种随意和侥幸的心态，就有可能导致更多更重要的隐私被一次性泄露，从而带来非常大的危害。</p>
<h4 id="作品功能"><a href="#作品功能" class="headerlink" title="作品功能"></a>作品功能</h4><p>经过项目组的讨论和意见交换，分析上述情况出现的原因主要有以下三点：</p>
<p><strong>1.文件的发布者隐私保护意识不强。</strong></p>
<p><strong>2.群里人员鱼龙混杂。</strong></p>
<p><strong>3.群文件明文可见。</strong></p>
<p>对发布者的隐私保护意识的提升，光有宣传，效果是不大的，只有通过设计出一款人性化的软件来使他们在不知不觉中形成这种习惯。而群里人员鱼龙混杂，则主要归因于群成员缺乏身份认证。群文件明文可见，则是由于对群成员缺乏分层管理，导致可拓展性低。</p>
<p>为了保证群文件的安全，我们的应用程序打算做到以下几点：</p>
<p>1.群文件加密保存。</p>
<p>2.群成员实名认证。</p>
<p>3.对群成员进行分级权限管理。</p>
<p>4.提醒管理员注意群文件的安全。</p>
<p>这意味着需要实现如下功能：</p>
<p>1.通过<strong>权限分级</strong>实现<strong>权限管理</strong>，控制每个用户所能解密的文件等级，以保证保密级别较高的文件具有比较好的保密性。</p>
<p>2.通过<strong>基于CRT的密钥分发</strong>系统，具体实现文件的<strong>访问控制</strong>，使级别较低的人不能解密级别较高的文件</p>
<p>3.通过<strong>实名制与重名查询</strong>，实现辅助的<strong>身份认证</strong>。</p>
<p>4.当群成员退出或者权限降低后，<strong>密钥自动更新</strong>，使得退出群组的成员无法再解密群中的文件。</p>
<p>群成员的权限管理该采用什么模型呢？当时我在学操作系统安全，在寒假的预习过程中，我预习到了一种模型，叫做Biba模型，当看到这个模型的思路的什么，我就觉得，它正好可以用在我们项目组研制的软件中，根据Biba模型，我做出了一些调整，最终软件所能实现的分层管理功能就是：任何一个等级的群成员，只能浏览安全等级小于或者等于这个等级的群文件。例如，安全等级为4的用户可以得知安全等级为1,2,3,4的文件的密码(这个用户的私钥可以解密上述四种安全等级文件的会话密钥)，而安全等级为4的文件只可以被安全等级为4,5的用户查看(只要这些用户能通过解密相应信息或者这个文件的会话密钥)</p>
<p>而基于CRT的密钥分发技术则是在密码学课程中我十分感兴趣的技术。例如在一个交际系统中，A,B,C,D,E都有自己的私钥，若B,C,D需要在不透露自己的私钥的情况下进行沟通，那么可以生成一个会话密钥并通过CRT技术用B,C,D的私钥进行加密，B,C,D可以通过解密这条消息看到相应的会话密钥，而A,E则不行。这样就实现了一个小范围保密通信协议。</p>
<p>身份认证这方面，主要是重名查询。为免有人冒充群里已有的成员加入，每位成员加入的时候，系统会遍历一遍已有的群成员，如果已经存在该群成员，则系统会出现“Red Alert”，提醒管理员要十分注意核实该申请者的身份。同时每一位入群的成员都将被管理员设置成相应的安全级别。</p>
<p>故作品的关键流程与技术如下：</p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/2.png" alt></p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/3.png" alt></p>
<h4 id="作品实现"><a href="#作品实现" class="headerlink" title="作品实现"></a>作品实现</h4><p>作品最终实现了以下功能：群文件密钥分发，实名制，权限管理，密钥可更新，重名查询。</p>
<p>我的两位队友主要负责聊天软件的制作(Q群界面的模拟和身份认证功能的实现)，而我负责关键流程的算法设计和代码实现（权限管理，访问控制和密钥更新）。但是最后由于两部分的代码不太兼容，最后没调通，我就直接在eclipse上面展示关键代码的功能了。</p>
<p>关键代码部分（含注释）实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.math.BigInteger;<span class="comment">//用于支持java密钥的大数</span></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CRT</span> </span>&#123;</span><br><span class="line">;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		KEY []key=<span class="keyword">new</span> KEY[<span class="number">5</span>];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			key[i]=<span class="keyword">new</span> KEY(<span class="number">32</span>);<span class="comment">//对话密钥一般比用户密钥少，用户密钥需要稍大</span></span><br><span class="line">			System.out.println(<span class="string">"初始化用户密钥: key"</span>+(i+<span class="number">1</span>)+<span class="string">"="</span>+key[i].primekey);<span class="comment">//用户私钥</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> rank;<span class="comment">//文件等级</span></span><br><span class="line">		MOD m=<span class="keyword">new</span> MOD();</span><br><span class="line">		System.out.println(<span class="string">"自动生成模数:"</span>+m.primemod);</span><br><span class="line">		<span class="keyword">try</span> &#123;Thread.sleep(<span class="number">1000</span>);&#125;</span><br><span class="line">		<span class="keyword">catch</span>(Exception e) &#123;&#125;;</span><br><span class="line">		Scanner cin=<span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		<span class="comment">//某用户传送文件</span></span><br><span class="line">		KEY []Ks=<span class="keyword">new</span> KEY[<span class="number">5</span>];<span class="comment">//生成会话密钥</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			Ks[i]=<span class="keyword">new</span> KEY(<span class="number">30</span>);<span class="comment">//会话密钥要比普通密钥稍小</span></span><br><span class="line">			System.out.println(<span class="string">"初始化会话密钥: ks"</span>+(i+<span class="number">1</span>)+<span class="string">"="</span>+Ks[i].primekey);<span class="comment">//+"="+Ks[i].primekey</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;Thread.sleep(<span class="number">500</span>);&#125;<span class="comment">//这一段是为了在答辩时老师能慢慢的看变化，看得更清楚</span></span><br><span class="line">		<span class="keyword">catch</span>(Exception e) &#123;&#125;;</span><br><span class="line">		<span class="comment">//System.out.println("系统内部生成文件加密密钥中");//测试</span></span><br><span class="line">		</span><br><span class="line">		KEY []Kr=<span class="keyword">new</span> KEY[<span class="number">5</span>];</span><br><span class="line">		System.out.println(<span class="string">"根据文件等级生成传输密钥Kr"</span>);</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//第i+1级文件的CRT</span></span><br><span class="line">			<span class="comment">//System.out.println("根据文件等级生成传输密钥Kr"+(i+1));</span></span><br><span class="line">			Kr[i]=Ks[i].CRT(key,m,i+<span class="number">1</span>);<span class="comment">//根据CRT生成总密钥Kr,Ks是对应会话密钥,m是模数,(i+1)是等级</span></span><br><span class="line">			System.out.println(<span class="string">"Kr"</span>+(i+<span class="number">1</span>)+<span class="string">"="</span>+Kr[i].get());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;Thread.sleep(<span class="number">1000</span>);&#125;</span><br><span class="line">		<span class="keyword">catch</span>(Exception e) &#123;&#125;;</span><br><span class="line">        <span class="comment">//展示CRT分级管理后的效果</span></span><br><span class="line">		System.out.println(<span class="string">"测试：各等级用户能得到的密钥——请输入你想看的文件等级:"</span>);</span><br><span class="line">		rank=cin.nextInt();</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			BigInteger result=Kr[rank-<span class="number">1</span>].get().remainder(key[i].get());</span><br><span class="line">			System.out.println(<span class="string">"第"</span>+(i+<span class="number">1</span>)+<span class="string">"级用户得到的会话密钥是"</span>+result);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">int</span> k=<span class="number">2</span>;</span><br><span class="line">		<span class="keyword">while</span>(k&gt;<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			System.out.println(<span class="string">"新建用户"</span>);</span><br><span class="line">			User a=<span class="keyword">new</span> User();</span><br><span class="line">			<span class="keyword">int</span> j=<span class="number">2</span>;</span><br><span class="line">			<span class="keyword">while</span>(j&gt;<span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				System.out.println(<span class="string">"请输入你想看的文件级别:"</span>);</span><br><span class="line">				rank=cin.nextInt();</span><br><span class="line">				BigInteger result=Kr[rank-<span class="number">1</span>].get().remainder(key[a.rank-<span class="number">1</span>].get());</span><br><span class="line">				System.out.println(<span class="string">"用户得到的密钥是"</span>+result);</span><br><span class="line">				System.out.println(<span class="string">"测试：第"</span>+rank+<span class="string">"级文件会话密钥:"</span>+Ks[rank-<span class="number">1</span>].primekey);</span><br><span class="line">				<span class="comment">//System.out.println("是否继续？除y之外任意键退出查看文件并注销用户。");</span></span><br><span class="line">				j--;</span><br><span class="line">				<span class="keyword">try</span> &#123;Thread.sleep(<span class="number">5000</span>);&#125;</span><br><span class="line">				<span class="keyword">catch</span>(Exception e) &#123;&#125;;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//用户注销，执行析构函数</span></span><br><span class="line">			System.out.println(<span class="string">"用户注销，密钥将自动更新"</span>);</span><br><span class="line">			<span class="keyword">int</span> userank=a.get();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;userank;i++)</span><br><span class="line">			&#123;	</span><br><span class="line">				Ks[i]=<span class="keyword">new</span> KEY(<span class="number">30</span>);<span class="comment">//生成会话密钥</span></span><br><span class="line">				<span class="comment">//System.out.println("会话密钥已更新");</span></span><br><span class="line">				key[i]=<span class="keyword">new</span> KEY(<span class="number">32</span>);</span><br><span class="line">				<span class="comment">//System.out.println("等级私钥已更新");</span></span><br><span class="line">				System.out.println(<span class="string">"更新后的等级密钥: key"</span>+(i+<span class="number">1</span>)+<span class="string">"="</span>+key[i].primekey);</span><br><span class="line">				<span class="keyword">try</span> &#123;Thread.sleep(<span class="number">300</span>);&#125;</span><br><span class="line">				<span class="keyword">catch</span>(Exception e) &#123;&#125;;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//第i+1级文件的CRT</span></span><br><span class="line">				System.out.println(<span class="string">"重新根据文件等级生成传输密钥Kr"</span>+(i+<span class="number">1</span>));</span><br><span class="line">				Kr[i]=Ks[i].CRT(key,m,i+<span class="number">1</span>);<span class="comment">//根据CRT生成总密钥Kr,Ks是对应会话密钥,m是模数,(i+1)是等级</span></span><br><span class="line">				System.out.println(<span class="string">"新的Kr"</span>+(i+<span class="number">1</span>)+<span class="string">"="</span>+Kr[i].get());</span><br><span class="line">				<span class="keyword">try</span> &#123;Thread.sleep(<span class="number">100</span>);&#125;</span><br><span class="line">				<span class="keyword">catch</span>(Exception e) &#123;&#125;;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/*System.out.println("是否继续？除y之外任意键退出。");</span></span><br><span class="line"><span class="comment">			String str=cin.toString();</span></span><br><span class="line"><span class="comment">			str=cin.toString();</span></span><br><span class="line"><span class="comment">			if(str.charAt(0)!='y')</span></span><br><span class="line"><span class="comment">			&#123;</span></span><br><span class="line"><span class="comment">				break;</span></span><br><span class="line"><span class="comment">			&#125;*/</span></span><br><span class="line">		&#125;</span><br><span class="line">		k--;</span><br><span class="line">		<span class="keyword">try</span> &#123;Thread.sleep(<span class="number">3000</span>);&#125;</span><br><span class="line">		<span class="keyword">catch</span>(Exception e) &#123;&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> rank;</span><br><span class="line">	<span class="comment">//用户登录,输入密码,获得用户等级</span></span><br><span class="line">	User()</span><br><span class="line">	&#123;</span><br><span class="line">		Scanner ci=<span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">		System.out.println(<span class="string">"请输入用户等级:"</span>);</span><br><span class="line">		rank=ci.nextInt();<span class="comment">//测试用，手动输入用户等级,貌似有错误输入</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> rank;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MOD</span></span></span><br><span class="line"><span class="class">//生成模数</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	BigInteger primemod;</span><br><span class="line">	MOD()</span><br><span class="line">	&#123;</span><br><span class="line">		Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">		<span class="keyword">byte</span> []rand_byte=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">35</span>];</span><br><span class="line">		rand.nextBytes(rand_byte);</span><br><span class="line">		rand_byte[<span class="number">0</span>]=<span class="number">1</span>;<span class="comment">//为了让模数大于密码</span></span><br><span class="line">		BigInteger a=<span class="keyword">new</span> BigInteger(rand_byte),b=<span class="keyword">new</span> BigInteger(rand_byte);</span><br><span class="line">		primemod=a.multiply(b);</span><br><span class="line">		primemod=primemod.nextProbablePrime();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">BigInteger <span class="title">get</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span>  primemod;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KEY</span></span></span><br><span class="line"><span class="class">//密钥生成</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	BigInteger primekey;</span><br><span class="line">	KEY()</span><br><span class="line">	&#123;</span><br><span class="line">		Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">		<span class="keyword">byte</span> []rand_byte=<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">32</span>];</span><br><span class="line">		rand.nextBytes(rand_byte);</span><br><span class="line">		BigInteger a=<span class="keyword">new</span> BigInteger(rand_byte);<span class="comment">//随机大正数</span></span><br><span class="line">		a=a.abs();</span><br><span class="line">		primekey=a.nextProbablePrime();</span><br><span class="line">	&#125;</span><br><span class="line">	KEY(<span class="keyword">int</span> i)</span><br><span class="line">	&#123;</span><br><span class="line">		Random rand=<span class="keyword">new</span> Random();</span><br><span class="line">		<span class="keyword">byte</span> []rand_byte=<span class="keyword">new</span> <span class="keyword">byte</span>[i];</span><br><span class="line">		rand.nextBytes(rand_byte);</span><br><span class="line">		BigInteger a=<span class="keyword">new</span> BigInteger(rand_byte);<span class="comment">//随机大正数</span></span><br><span class="line">		a=a.abs();</span><br><span class="line">		primekey=a.nextProbablePrime();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">BigInteger <span class="title">get</span><span class="params">()</span><span class="comment">//输出</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span>  primekey;</span><br><span class="line">	&#125;</span><br><span class="line">	KEY(BigInteger a)</span><br><span class="line">	&#123;</span><br><span class="line">		primekey=a;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(BigInteger b)</span><span class="comment">//修改</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		primekey=b;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">KEY <span class="title">CRT</span><span class="params">(KEY key[],MOD m,<span class="keyword">int</span> rank)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		KEY Kr=<span class="keyword">new</span> KEY(BigInteger.ZERO);</span><br><span class="line">		BigInteger []x=<span class="keyword">new</span> BigInteger[<span class="number">5</span>];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">5</span>;i++)<span class="comment">//把密钥分发给需要的人</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(i&lt;rank)<span class="comment">//比如等级是三级的文件，1，2级不能看，密钥填0</span></span><br><span class="line">			&#123;</span><br><span class="line">				x[i-<span class="number">1</span>]=BigInteger.ZERO;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				x[i-<span class="number">1</span>]=primekey;<span class="comment">//Ks[i]，即对应的会话密钥</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		BigInteger p=m.get();</span><br><span class="line">		BigInteger Mn=BigInteger.ONE;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			Mn=Mn.multiply(key[i].get());</span><br><span class="line">		&#125;</span><br><span class="line">		BigInteger []W=<span class="keyword">new</span> BigInteger[<span class="number">5</span>];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			W[i]=Mn.divide(key[i].get());</span><br><span class="line">		&#125;</span><br><span class="line">		BigInteger []T=<span class="keyword">new</span> BigInteger[<span class="number">5</span>];<span class="comment">//开辟了数组空间</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			T[i]=W[i].modInverse(key[i].get());</span><br><span class="line">		&#125;</span><br><span class="line">		BigInteger result=BigInteger.ZERO;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			result=result.add(x[i].multiply(W[i].multiply(T[i])));</span><br><span class="line">		&#125;</span><br><span class="line">		result=result.remainder(Mn);<span class="comment">//咋变成0了</span></span><br><span class="line">		<span class="comment">//result=result.remainder(p);</span></span><br><span class="line">		Kr.push(result);</span><br><span class="line">		<span class="keyword">return</span> Kr;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在测试中，我们的展示流程是这样的：</p>
<p>初始化群用户密钥并生成每类文件的会话密钥。</p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/4.png" alt></p>
<p>自动生成每类等级文件密钥的加密信息。</p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/5.png" alt></p>
<p>测试CRT定理对密钥分发的有效性：</p>
<p>每个级别的用户对于某个文件等级的文件，能获取到的密钥(样例文件等级为3)：</p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/7.png" alt></p>
<p>用户入群后，随意访问文件密钥，但是只能看到安全等级比较低的文件，不能访问安全等级比自己等级高的文件。</p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/6.png" alt></p>
<p>密钥更新部分，密钥更新产生了新的会话密钥，老用户不再能使用之前的密钥。(PPT没有截图，具体实现可以看代码)</p>
<h4 id="质疑与争论"><a href="#质疑与争论" class="headerlink" title="质疑与争论"></a>质疑与争论</h4><p><strong>我的质疑</strong>：</p>
<p>在答辩前，我写了一份有关这个项目的优势和劣势的一些分析并交予小组成员一起讨论，主要有如下几点：</p>
<p>1.在鱼龙混杂的qq群中，如果管理员真的愿意耐心的给每一个人和文件分配权限的话，那么权限比较低的人看不到权限比较高的文件。那么如果是权限比较高的人出了问题呢？比如管理员的号被盗了怎么办？</p>
<p>2.我们给他足够高的权限意味着我们足够相信他，但是泄密者不一定是本人，也不一定是前员工，如果只是qq号被攻击者窃取了，那么别人是可以在管理员不知情的情况下获取文件内容的。如果文件内容被获取，那么截图或者下载，总有可能是会泄露的。</p>
<p>3.如果我们实在担心文件的安全，为什么还一定要把文件上传到qq而不通过其他方式分享文件？</p>
<p>4.不可否认，通过入群的认证,离开群后更新密钥和分级管理是可以起到一定保护作用。但这种方式的性价比真的高吗，真的值得吗？</p>
<p>不可否认，我可能想得有点多，但是关于上述几个问题，的确值得商榷，最让我担心的还是项目的性价比和应用前景。</p>
<p><strong>团队总结的遗留问题：</strong></p>
<p>经过一番讨论，我们在答辩过程中提出了如下的不足之处和创新点：</p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/8.png" alt></p>
<p><img src="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/9.png" alt></p>
<p><strong>老师的质疑：</strong></p>
<p>项目答辩的时候，老师也问了这个项目的应用前景，他们觉得没有这个必要。因为完全可以建一个小一些的Q群，或者使用更安全的公司内部网络。他们建议，我们把这个问题上升到公司内部文件系统的安全上面去，不然看着觉得很好，但是想着又觉得又有点虚。</p>
<hr>
<p>2020.4.21随想</p>
<p>有时候人性的弱点带来的危险最大，我之前虽然会看入群验证但很少核实信息是否真实。所以我觉得一个应用，最主要的还是要解决人的问题，方便人的生活，同时自然就能保证安全了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/" data-id="ck9odqwkl000dpguc9tqlg4i9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/project/" rel="tag">project</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="w-lz77编码选做实验过程笔记" class="article article-type-w" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2020-04-03T13:54:13.000Z" itemprop="datePublished">2020-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/">lz77编码选做实验过程笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="多媒体原理与系统设计选做实验"><a href="#多媒体原理与系统设计选做实验" class="headerlink" title="多媒体原理与系统设计选做实验"></a>多媒体原理与系统设计选做实验</h1><h3 id="编码算法完善过程"><a href="#编码算法完善过程" class="headerlink" title="编码算法完善过程"></a>编码算法完善过程</h3><p>先把LZ77算法的伪代码拷贝下来</p>
<p><img src="/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20200403190150298.png" alt="image-20200403190150298"></p>
<h4 id="1-else分支"><a href="#1-else分支" class="headerlink" title="1.else分支"></a>1.else分支</h4><p>需要补充的代码是else分支的处理代码。由于数据结构是固定的，因此只能输入0，0和next_char的三元组信息。如果要设计更复杂的实现算法和数据结果的话，可以把0省略，以实现更大程度的压缩。</p>
<p>先看看if分支的代码有没有可以借鉴的地方：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">swprintf(code, <span class="number">125</span>, <span class="string">L"(%d,%d,%lc)"</span>, offset, length, source[pointer+length] );<span class="comment">//输出三元组，需要借鉴保留，因为不匹配，length=0和offset=0必定满足</span></span><br><span class="line">			cpy_len = wcslen(code);<span class="comment">//计算新增编码长度，借鉴保留</span></span><br><span class="line">			</span><br><span class="line">			wcscpy_s(codes + code_size,cpy_len+<span class="number">1</span>, code);<span class="comment">//应该是用于展示的，借鉴保留</span></span><br><span class="line"></span><br><span class="line">			pointer = pointer + length + <span class="number">1</span>;<span class="comment">//指针移动，但是length=0，只需要借鉴保留</span></span><br><span class="line">			code_size+= cpy_len;<span class="comment">//更新总编码长度，借鉴保留</span></span><br></pre></td></tr></table></figure>

<p>于是就得到如下代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//没有发现匹配字符串时，输入0，0和next_char信息</span></span><br><span class="line">			<span class="comment">//******************************************************************</span></span><br><span class="line">			<span class="comment">//**                 此处需要你补全代码</span></span><br><span class="line">			<span class="comment">//******************************************************************</span></span><br><span class="line">			<span class="comment">//开始你的代码</span></span><br><span class="line">			swprintf(code, <span class="number">125</span>, <span class="string">L"(%d,%d,%lc)"</span>, offset, length, source[pointer + length]);<span class="comment">//输出三元组</span></span><br><span class="line">			cpy_len = wcslen(code);</span><br><span class="line"></span><br><span class="line">			wcscpy_s(codes + code_size, cpy_len + <span class="number">1</span>, code);</span><br><span class="line"></span><br><span class="line">			pointer = pointer + length + <span class="number">1</span>;</span><br><span class="line">			code_size += cpy_len;</span><br><span class="line">			<span class="comment">//结束你的代码</span></span><br><span class="line">			<span class="comment">//******************************************************************</span></span><br></pre></td></tr></table></figure>

<h4 id="2-报文尾部"><a href="#2-报文尾部" class="headerlink" title="2.报文尾部"></a>2.报文尾部</h4><p>先看看如何判断是到了报文尾部。按照一般的情况，可能需要记录报文的长度或者剩余报文的字数，如果当前指针偏移达到报文长度或者剩余报文长度为0的话，就意味着到了报文结尾。也可以通过某种特殊符号记录报文末尾。</p>
<p>观察代码，找到了程序相关变量：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//source明文，winsize窗口大小,codes编码后文字</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lz77_coder</span><span class="params">(WCHAR* source, <span class="keyword">int</span> win_size, WCHAR* codes)</span></span></span><br><span class="line"><span class="function"></span>&#123;		</span><br><span class="line">	<span class="keyword">size_t</span> source_len = wcslen(source);<span class="comment">//计算原文字符串长度</span></span><br></pre></td></tr></table></figure>

<p>那么如果win_size_real为0，就意味着到达了报文末尾了。可以补全相关代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//达到报文末尾时，退出编码循环</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br><span class="line"><span class="comment">//**                 此处需要你补全代码</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br><span class="line"><span class="comment">//开始你的代码</span></span><br><span class="line"><span class="keyword">if</span> (source_len &lt;= pointer)<span class="comment">//把常量写左边，以防写错比较符号</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结束你的代码</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br></pre></td></tr></table></figure>

<h3 id="解码算法完善过程"><a href="#解码算法完善过程" class="headerlink" title="解码算法完善过程"></a>解码算法完善过程</h3><p>解码算法没有相应的伪代码，但是可以参照编码算法来完善。</p>
<p>首先了解源程序每个循环的作用和如何解析三元组找到offset的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//每个循环都解析一个编码，结构为：(offset,length,next_char)，最后一个编码的右边可能缺少next_char和)</span></span><br><span class="line"><span class="comment">//找到offset</span></span><br><span class="line">		<span class="keyword">while</span>(codes[idx] != <span class="string">','</span>)<span class="comment">//三元组的第一元，读到逗号为止</span></span><br><span class="line">		&#123;</span><br><span class="line">			idx++;</span><br><span class="line">		&#125;</span><br><span class="line">		token_sz = idx - start_idx;<span class="comment">//忽略逗号的长度，正好把两个逗号长度抵消</span></span><br><span class="line">		copy_str1_to_str0(token, codes+start_idx, token_sz);<span class="comment">//把offset取出来</span></span><br><span class="line">		offset = _wtoi(token);<span class="comment">//把内容是数字的字符串转换整型数字</span></span><br><span class="line">		idx++;<span class="comment">//忽略逗号</span></span><br></pre></td></tr></table></figure>

<p>于是可以轻松补充出找到length的代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//找到length</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br><span class="line"><span class="comment">//**                 此处需要你补全代码</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br><span class="line"><span class="comment">//开始你的代码</span></span><br><span class="line">idx++;<span class="comment">//目前的位置是逗号，往后走一位</span></span><br><span class="line">start_idx = idx;</span><br><span class="line"></span><br><span class="line"><span class="comment">//找到offset</span></span><br><span class="line"><span class="keyword">while</span> (codes[idx] != <span class="string">','</span>)</span><br><span class="line">&#123;</span><br><span class="line">	idx++;</span><br><span class="line">&#125;</span><br><span class="line">token_sz = idx - start_idx;<span class="comment">//忽略逗号的长度，也是刚好抵消</span></span><br><span class="line">copy_str1_to_str0(token, codes + start_idx, token_sz);</span><br><span class="line">length = _wtoi(token);<span class="comment">//把内容是数字的字符串转换整型数字</span></span><br><span class="line">idx++;<span class="comment">//忽略逗号</span></span><br><span class="line"><span class="comment">//结束你的代码</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br></pre></td></tr></table></figure>

<p>考虑到最后一个编码的右边可能缺少next_char和)，找到next_char的代码需要出现一些分支判断。而且next_char不是数字，本身是一个字符，所以这部分代码需要修改:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//找到next_char</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br><span class="line"><span class="comment">//**                 此处需要你补全代码</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br><span class="line"><span class="comment">//开始你的代码</span></span><br><span class="line">idx++;<span class="comment">//目前的位置是逗号，往后走一位</span></span><br><span class="line">start_idx = idx;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否是最后一个编码</span></span><br><span class="line"><span class="keyword">if</span> (idx &gt;= codes_len)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//最后一个编码了</span></span><br><span class="line">	next_char = <span class="string">'\0'</span>;<span class="comment">//结束符,反正都是要附加上去的，加上结束符刚好</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	next_char = codes[idx];<span class="comment">//这就是next_char</span></span><br><span class="line">	idx += <span class="number">2</span>;<span class="comment">//加一是右括号，加二才可能到达左括号</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结束你的代码</span></span><br><span class="line"><span class="comment">//******************************************************************</span></span><br></pre></td></tr></table></figure>

<p>然后补全解码时输出匹配字符串和最后一个附加的next_char字符的代码，我看到next_char已经输出了，那么接下来最主要的就是根据length和offset找到匹配字符串，然后把匹配字符串按字符一个个附加到解码字符串后面：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; length; i++)<span class="comment">//这里已经在length的循环里面了</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//******************************************************************</span></span><br><span class="line">	<span class="comment">//**                 此处需要你补全代码</span></span><br><span class="line">	<span class="comment">//******************************************************************</span></span><br><span class="line">	<span class="comment">//开始你的代码</span></span><br><span class="line">	decodes[decodes_idx++] = decodes[(decodes_idx++) - offset];</span><br><span class="line">	<span class="comment">//结束你的代码</span></span><br><span class="line">	<span class="comment">//******************************************************************	</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调试与运行"><a href="#调试与运行" class="headerlink" title="调试与运行"></a>调试与运行</h3><p>一开始的时候，编码算法和原文对比是没有问题的，但是解码的时候出现了问题：</p>
<p><img src="/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20200403211706525.png" alt="image-20200403211706525"></p>
<p>明显所有的nextchar都被读成了右括号。后来发现原来是自己的代码里面重复了一次id++。</p>
<p><img src="/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20200403212041843.png" alt="image-20200403212041843"></p>
<p>把其中一处删掉，更改后寻找next_char代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">start_idx = idx;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//判断是否是最后一个编码</span></span><br><span class="line">		<span class="keyword">if</span> (idx &gt;= codes_len)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//最后一个编码了</span></span><br><span class="line">			next_char = <span class="string">'\0'</span>;<span class="comment">//结束符,反正都是要附加上去的，加上结束符刚好</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			next_char = codes[idx];<span class="comment">//这就是next_char</span></span><br><span class="line">			idx += <span class="number">2</span>;<span class="comment">//加一是右括号，加二才可能到达左括号</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行，还是稍微有一些问题：</p>
<p><img src="/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20200403212319194.png" alt="image-20200403212319194"></p>
<p>观察丢失字符的特性，可以发现重复的字符串的字符完全丢失，只有输出next_char的部分是完全正确的。</p>
<p>那么就可能是寻找offset的代码或者输出的相关代码出现问题。</p>
<p>找到输出相应代码：</p>
<p><code>decodes[decodes_idx++] = decodes[(decodes_idx++) - offset];</code></p>
<p>发现我的一句代码里面出现了两次i++，这样就导致一次寻常指针往后走了两个位置。重新修改这段代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当offset和length不为0时，输出匹配字符串和最后一个附加的next_char字符</span></span><br><span class="line">			start_idx = decodes_idx;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; length; i++)<span class="comment">//这里已经在length的循环里面了</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//******************************************************************</span></span><br><span class="line">				<span class="comment">//**                 此处需要你补全代码</span></span><br><span class="line">				<span class="comment">//******************************************************************</span></span><br><span class="line">				<span class="comment">//开始你的代码</span></span><br><span class="line">				decodes[decodes_idx++] = decodes[(decodes_idx) - offset];</span><br><span class="line">				<span class="comment">//结束你的代码</span></span><br><span class="line">				<span class="comment">//******************************************************************	</span></span><br><span class="line">			&#125;</span><br><span class="line">			decodes[decodes_idx++] = next_char;</span><br></pre></td></tr></table></figure>

<p>但是这一部分的失误不可能导致字符串整个丢失，那么获取length的算法肯定也存在一些问题。结果我发现了和上面一样的问题。</p>
<p><img src="/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20200403213722664.png" alt="image-20200403213722664"></p>
<p>还是删除最下面的idx，于是运行成功：</p>
<p><img src="/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/image-20200403213826058.png" alt="image-20200403213826058"></p>
<h3 id="感受"><a href="#感受" class="headerlink" title="感受"></a>感受</h3><p>通过选做实验完善课程项目的编程其实真的是一种很棒的教学形式。就如同在科研团队或者工作中，一个大项目被分成若干的部分，每个人完成其中一小部分。这需要项目参与者的相互配合，交流并了解对方代码的含义。要使用统一的变量和接口函数，以免在代码衔接过程中产生bug，使得软件出现功能的不符合或者安全脆弱点。当然，为了验证程序的重要性，调试和测试阶段也是不可免的。</p>
<p>这次编程过程，出现了很多的小问题，特别是相同的错误在两段代码里都出现了，所以体现出自己在补充代码时可能会考虑没有这么全面，但是通过代码测试和代码审计，最终把所有错误纠正了，也熟悉了一次lz77编解码的相关知识，这个过程本身就是很值得的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/03/lz77%E7%BC%96%E7%A0%81%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E7%AC%94%E8%AE%B0/" data-id="ck9odqwk10004pgucdawvgjem" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/study/" rel="tag">study</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-极光实验室战队考核密码学部分考察点与题解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/" class="article-date">
  <time datetime="2020-04-01T13:36:17.000Z" itemprop="datePublished">2020-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/">极光实验室战队考核密码学部分考察点与题解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="实验室战队考核新人赛题目点评与WP"><a href="#实验室战队考核新人赛题目点评与WP" class="headerlink" title="实验室战队考核新人赛题目点评与WP"></a>实验室战队考核新人赛题目点评与WP</h2><h4 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h4><p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/image-20200404204929407.png" alt="image-20200404204929407"></p>
<h4 id="出题思路"><a href="#出题思路" class="headerlink" title="出题思路"></a>出题思路</h4><p>由于是战队考核，这次的题目应出得相对综合，也更考验同学们的知识面和对各方面加密的理解和把握能力。同时，题目应当结合密码学的实际应用，有生动的背景和场景。</p>
<p>出题前，我在网上做了两三道rsa和aes的题目，觉得出题点还是比较单一，于是联想了一下之前做过的一些印象深刻的密码学题目，于是我想到了把密码学实验和aes，rsa结合起来，出一次改进版的中间人攻击，作为密码学实验的补充。之所以要和aes，rsa结合，是因为通过混合密码通信的安全性更高，效率也更好。我们段老师的PPT是这么说的：</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/image-20200402112220312.png" alt="image-20200402112220312"></p>
<p>但是，如果rsa加密过程中存在某些问题呢？假如rsa私钥部分泄露呢？那面对中间人的攻击，这种通信方法也难以保证它的安全性。见如下<a href="王小云,刘明洁.格密码学研究[J].密码学报,2014,1(01):13-27.">参考论文</a>:</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/.%5C%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3%5C7.png" alt="7"></p>
<p>在题目环境中，我就让私钥最低位的一半比特泄露出来，这是足够解对称密码私钥的了。根据等式：<br>$$<br>e * d == 1 mod phi(N)<br>$$<br>我们引入常数k，使得:<br>$$<br>e * d - k * phi(N) == 1<br>$$<br>由于e模phi的逆：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d = gmpy2.invert(e,phi)</span><br></pre></td></tr></table></figure>

<p>所以对于上述等式，有：</p>
<p>$$<br>phi(N) &gt; d<br>$$</p>
<p>那么就有：<br>$$<br>k&lt;e<br>$$<br>由于e一般在16位以下（题目中不超过1024），所以k是可爆破的。</p>
<p>我们对等式两边都模上2的1050次方，并化简：<br>$$<br>(e * d - k * phi(N)) mod 2<strong>1050 == 1 mod 2</strong>1050<br>$$</p>
<p>$$<br>((e mod 2<strong>1050) * (d mod 2</strong>1050) - k * phi(N) ) mod 2<strong>1050 == 1 mod 2</strong>1050<br>$$</p>
<p>$$<br>(e * d0 - k<em>phi(N)) mod 2*</em>1050 == 1 mod 2**1050<br>$$</p>
<p>$$<br>e * d0 - k<em>phi(N) == 1 mod 2*</em>1050<br>$$</p>
<p>方程两边同乘q，并代入等式：<br>$$<br>phi(N)==(p-1)<em>(q-1)<br>$$<br>以及<br>$$<br>N==p<em>q<br>$$<br>可以得到：<br>$$<br>e</em>d0*p - k</em>(n<em>p-p</em>p-n+p) == p mod 2**1050<br>$$<br>所以只需要对k进行遍历，然后对每一个k通过sage解同余方程即可。</p>
<p>获取了对称密码的私钥以后，消息明文便不难获取了。同时，和密码学实验一样，我们假设中间人有着足够的能力完成近乎实时的通信，在没有认证机制的DH通信协议中，他就可以冒充通信双方进行欺骗。<em>这里为了保证实时性，本来应该进行时间限制的，这样大家就只能通过python的pwntools工具来进行交互了。但是考虑到考点比较综合，任务量大，在12小时之内能写出这么多脚本的可能性不太大，所以就不限制时间了。</em></p>
<h4 id="考察点"><a href="#考察点" class="headerlink" title="考察点"></a>考察点</h4><p>AES(CBC和ECB）加解密， 铜匠攻击，DH通信协议，中间人攻击，base64加解密</p>
<h4 id="出题过程"><a href="#出题过程" class="headerlink" title="出题过程"></a>出题过程</h4><p>首先，还是建立两个文件，Arica.py和conversation.py，保存一些不想公布的变量值:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Arica.py</span></span><br><span class="line">key=<span class="string">b'grzu7KTaDuiiBVWL'</span></span><br><span class="line">flag=<span class="string">b'ACTF&#123;You_have_got_the_flag!That_is_impossible!&#125;'</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#conversation.py</span></span><br><span class="line">questions = [</span><br><span class="line">    <span class="string">b"Who are you?"</span>,</span><br><span class="line">    <span class="string">b"Oh my dear Brooke, I miss you so much!"</span>,</span><br><span class="line">    <span class="string">b"Brooke, I was so lonely during the outbreak of Novel coronavirus!"</span>,</span><br><span class="line">    <span class="string">b"Brooke, do you mind me asking you a few more question?"</span>,</span><br><span class="line">    <span class="string">b"What can I do for you?"</span>]</span><br><span class="line">answer = [</span><br><span class="line">    <span class="string">b"I'm Brooke."</span>,</span><br><span class="line">    <span class="string">b"I miss you too."</span>,</span><br><span class="line">    <span class="string">b"Me too! I wanna go out for dance!"</span>,</span><br><span class="line">    <span class="string">b"Not at all."</span>,</span><br><span class="line">    <span class="string">b"Nothing."</span>]</span><br><span class="line">fake_answer=<span class="string">b"I want to get my AES-key."</span></span><br><span class="line">saying_key=<span class="string">b"Here is the key: "</span></span><br></pre></td></tr></table></figure>

<p>然后在windows上写了针对key的加密函数(aes-cbc)和针对flag的加密函数(泄露私钥的rsa函数)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encryption.py</span></span><br><span class="line"><span class="keyword">from</span> Cryptodome.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Arica <span class="keyword">import</span> key,flag</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Cryptodome.Util.number <span class="keyword">import</span> (</span><br><span class="line">    bytes_to_long,</span><br><span class="line">    long_to_bytes,</span><br><span class="line">    str2long,</span><br><span class="line">    long2str,</span><br><span class="line">    getPrime</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> Cryptodome.Random.random <span class="keyword">import</span> (</span><br><span class="line">    getrandbits,</span><br><span class="line">    randint</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">p = <span class="number">217534615279223294476101434763509239207</span></span><br><span class="line">g = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_flag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    flag = adaptmessage(flag)</span><br><span class="line">    c = aes.encrypt(flag)</span><br><span class="line">    print(<span class="string">"Here is the encrypted flag: "</span>+str(base64.b64encode(c)))</span><br><span class="line">    <span class="comment">#b'gTAmtDzEDIYdzs6j55csresodxpsKJlOVMOmzLq8/39Vm0lJZvnrGtPBW6IKUpML'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_key</span><span class="params">()</span>:</span></span><br><span class="line">    e = <span class="number">1667</span></span><br><span class="line">    p = getPrime(<span class="number">700</span>)</span><br><span class="line">    q = getPrime(<span class="number">1400</span>) </span><br><span class="line">    n = p*q</span><br><span class="line">    print(<span class="string">"""+------------------------------------------------------+</span></span><br><span class="line"><span class="string">|Attension! Through soical engineering, you got this: |</span></span><br><span class="line"><span class="string">+------------------------------------------------------+"""</span>)</span><br><span class="line">    phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">    d = gmpy2.invert(e,phi)</span><br><span class="line">    print(<span class="string">"n = "</span>+str(n))</span><br><span class="line">    <span class="comment">#print(d)</span></span><br><span class="line">    print(<span class="string">"Brooke's partial d: "</span>+ str(int(d) % (<span class="number">2</span>**<span class="number">1050</span>)))</span><br><span class="line">    enc = pow(bytes_to_long(key), e, n)</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generateDH</span><span class="params">(exp)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> pow(g, exp, p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">adaptmessage</span><span class="params">(message)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> message.ljust(<span class="number">16</span>-len(message)%<span class="number">16</span>+len(message), <span class="string">b"\x00"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aricaSay</span><span class="params">(*args)</span>:</span></span><br><span class="line">    print(<span class="string">"""+-------------------+</span></span><br><span class="line"><span class="string">|    Arica said:    |</span></span><br><span class="line"><span class="string">+-------------------+"""</span>)</span><br><span class="line">    print(<span class="string">" "</span>.join(map(str,args)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brookeSay</span><span class="params">(*args)</span>:</span></span><br><span class="line">    print(<span class="string">"""+--------------------+</span></span><br><span class="line"><span class="string">|    Brooke said:    |</span></span><br><span class="line"><span class="string">+--------------------+"""</span>)</span><br><span class="line">    print(<span class="string">" "</span>.join(map(str,args)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say2arica</span><span class="params">(*args)</span>:</span></span><br><span class="line">    print(<span class="string">"""+---------------------+</span></span><br><span class="line"><span class="string">|    Say to Arica:    |</span></span><br><span class="line"><span class="string">+---------------------+</span></span><br><span class="line"><span class="string">"""</span>+ <span class="string">" "</span>.join(map(str,args)), end=<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">return</span> input()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say2brooke</span><span class="params">(*args)</span>:</span></span><br><span class="line">    print(<span class="string">"""+----------------------+</span></span><br><span class="line"><span class="string">|    Say to Brooke:    |</span></span><br><span class="line"><span class="string">+----------------------+</span></span><br><span class="line"><span class="string">"""</span> + <span class="string">" "</span>.join(map(str,args)), end=<span class="string">""</span>)</span><br><span class="line">    <span class="keyword">return</span> input()</span><br></pre></td></tr></table></figure>

<p>然后把DH通信的脚本和题目情景写好：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> encryption <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> conversation <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">banner = <span class="string">"""</span></span><br><span class="line"><span class="string">+--------------------------------------------------+</span></span><br><span class="line"><span class="string">|HELLO CHALLENGER!                                 |</span></span><br><span class="line"><span class="string">|                                                  |</span></span><br><span class="line"><span class="string">|Have you ever seen movies like MISSION IMPOSSIBLE?|</span></span><br><span class="line"><span class="string">|Unfortunately, You have got a mission that seemed |</span></span><br><span class="line"><span class="string">|impossible to finish!                             |</span></span><br><span class="line"><span class="string">|                                                  |</span></span><br><span class="line"><span class="string">|In the task, you are required to decrypt the      |</span></span><br><span class="line"><span class="string">|'Most secret' message of Arica, the bank clerk.   |</span></span><br><span class="line"><span class="string">|                                                  |</span></span><br><span class="line"><span class="string">|Fortunately, after social engineering you have    |</span></span><br><span class="line"><span class="string">|hacked in her communication with her boyfriend    |</span></span><br><span class="line"><span class="string">| Brooke and you have got Brooke's partial         |</span></span><br><span class="line"><span class="string">|RSA-private-key.                                  |</span></span><br><span class="line"><span class="string">|                                                  |</span></span><br><span class="line"><span class="string">|To get the message, you must first establish      |</span></span><br><span class="line"><span class="string">| communication with Arica through 'DH key exchange|</span></span><br><span class="line"><span class="string">| protocol', chat with her by saying what Brooke   |</span></span><br><span class="line"><span class="string">|said, but you need to send the message            |</span></span><br><span class="line"><span class="string">| "I want to get my AES-key." and the timestamp    |</span></span><br><span class="line"><span class="string">| after Arica said "What can I do for you?",       |</span></span><br><span class="line"><span class="string">|then she will give the AES-key encrypted with her |</span></span><br><span class="line"><span class="string">| RSA-public-key，this message should be start with|</span></span><br><span class="line"><span class="string">| "Here is the key:".                              |</span></span><br><span class="line"><span class="string">+--------------------------------------------------+</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    print(banner)</span><br><span class="line">    encrypt_flag()</span><br><span class="line">    enc = encrypt_key()</span><br><span class="line">    expA = getrandbits(<span class="number">128</span>)</span><br><span class="line">    expB = getrandbits(<span class="number">128</span>)</span><br><span class="line">    A = generateDH(expA)</span><br><span class="line">    B = generateDH(expB)</span><br><span class="line">    aricaSay(<span class="string">"A:"</span>, A)</span><br><span class="line">    AC = int(say2brooke(<span class="string">"A: "</span>))</span><br><span class="line">    brookeSay(<span class="string">"B:"</span>, B)</span><br><span class="line">    BC = int(say2arica(<span class="string">"B: "</span>))</span><br><span class="line">    keyC = pow(AC, expB, p)</span><br><span class="line">    keyS = pow(BC, expA, p)</span><br><span class="line">    keyC = long_to_bytes(keyC).rjust(<span class="number">16</span>, <span class="string">b"\x00"</span>)</span><br><span class="line">    keyS = long_to_bytes(keyS).rjust(<span class="number">16</span>, <span class="string">b"\x00"</span>)</span><br><span class="line">    cipherC = AES.new(keyC, AES.MODE_ECB)</span><br><span class="line">    cipherS = AES.new(keyS, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">for</span> _i <span class="keyword">in</span> range(<span class="number">5</span>):<span class="comment">#5</span></span><br><span class="line">        index=_i</span><br><span class="line">        randomnum = randint(<span class="number">0</span>, <span class="number">256</span>)</span><br><span class="line">        messageA = questions[index]</span><br><span class="line">        messageA = adaptmessage(messageA)</span><br><span class="line">        cS = bytes_to_long(cipherS.encrypt(messageA))</span><br><span class="line">        aricaSay(<span class="string">"A:"</span>, <span class="string">"&#123;:032x&#125;"</span>.format(cS))</span><br><span class="line">        s = int(say2brooke(<span class="string">"A: "</span>), <span class="number">16</span>)</span><br><span class="line">        s = long_to_bytes(s)</span><br><span class="line">        q = cipherC.decrypt(s)</span><br><span class="line">        <span class="keyword">if</span> q != messageA:</span><br><span class="line">            print(<span class="string">"Brooke does't get your words and realize something, U FAILED..."</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        randomnum = randint(<span class="number">0</span>, <span class="number">256</span>)</span><br><span class="line">        messageB = answer[index]</span><br><span class="line">        messageB = adaptmessage(messageB)</span><br><span class="line">        cC = bytes_to_long(cipherC.encrypt(messageB))</span><br><span class="line">        brookeSay(<span class="string">"B:"</span>, <span class="string">"&#123;:032x&#125;"</span>.format(cC))</span><br><span class="line">        s = int(say2arica(<span class="string">"B: "</span>), <span class="number">16</span>)</span><br><span class="line">        s = long_to_bytes(s)</span><br><span class="line">        a = cipherS.decrypt(s)</span><br><span class="line">        <span class="keyword">if</span>(_i==<span class="number">4</span>):</span><br><span class="line">            messageB = fake_answer</span><br><span class="line">            messageB = adaptmessage(messageB)</span><br><span class="line">        <span class="keyword">if</span> a != messageB:</span><br><span class="line">            print(<span class="string">"Arica does't get your words and realize something, U FAILED..."</span>)</span><br><span class="line">            exit(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">    randomnum = randint(<span class="number">0</span>, <span class="number">256</span>)</span><br><span class="line">    messageA = saying_key+long_to_bytes(enc)</span><br><span class="line">    messageA = adaptmessage(messageA)</span><br><span class="line">    cS = bytes_to_long(cipherS.encrypt(messageA))</span><br><span class="line">    aricaSay(<span class="string">"A:"</span>, <span class="string">"&#123;:032x&#125;"</span>.format(cS))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>在出题过程中，根据自己的测试又稍微对题目更改了一下。</p>
<p>首先，在对aes私钥进行rsa加密的时候，一开始的e比较大，在1500左右，在测试中发现对于不同的d0值和n值，脚本的运行时间需要10分钟-3个小时，而3个小时在12个小时比赛时间里面所占比例太大，所以把e限制在1024以内，且设置为动态可变的数值。但是为了不增加难度，aeskey是固定的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_flag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">    flag = adaptmessage(flag)</span><br><span class="line">    c = aes.encrypt(flag)</span><br><span class="line">    print(<span class="string">"Here is the encrypted flag: "</span>+str(base64.b64encode(c)))</span><br><span class="line">    <span class="comment">#b'gTAmtDzEDIYdzs6j55csresodxpsKJlOVMOmzLq8/39Vm0lJZvnrGtPBW6IKUpML'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_key</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#e = 1667</span></span><br><span class="line">    p = getPrime(<span class="number">700</span>)</span><br><span class="line">    q = getPrime(<span class="number">1400</span>) </span><br><span class="line">    n = p*q</span><br><span class="line">    print(<span class="string">"""+------------------------------------------------------+</span></span><br><span class="line"><span class="string">|Attension! Through soical engineering, you got this: |</span></span><br><span class="line"><span class="string">+------------------------------------------------------+"""</span>)</span><br><span class="line">    phi = (p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        e=getPrime(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">if</span>(phi%e!=<span class="number">0</span>):</span><br><span class="line">            print(<span class="string">"e = "</span>+str(e))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    d = gmpy2.invert(e,phi)</span><br><span class="line">    print(<span class="string">"n = "</span>+str(n))</span><br><span class="line">    <span class="comment">#print(d)</span></span><br><span class="line">    print(<span class="string">"Brooke's partial d: "</span>+ str(int(d) % (<span class="number">2</span>**<span class="number">1050</span>)))<span class="comment">#d有问题</span></span><br><span class="line">    enc = pow(bytes_to_long(key), e, n)</span><br><span class="line">    <span class="keyword">return</span> enc</span><br></pre></td></tr></table></figure>

<p>另外由于DH的g为2，所以公钥应当为大于0的整数(不管你是1或者g**y%p，都不可能是0)，所以加入了一段代码检验：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#之所以要做出这个判断，是因为公钥真的不可能为0或负数</span></span><br><span class="line"><span class="keyword">if</span>(AC &lt;=<span class="number">0</span>):</span><br><span class="line">    brookeSay(<span class="string">"You are not Arica! Her public key should not be:"</span>, AC)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line">brookeSay(<span class="string">"B:"</span>, B)</span><br><span class="line">BC = int(say2arica(<span class="string">"B: "</span>))</span><br><span class="line"><span class="keyword">if</span>(BC &lt;=<span class="number">0</span>):</span><br><span class="line">    aricaSay(<span class="string">"You are not Brooke! His public key should not be:"</span>, BC)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>另外，为了考察大家有没有细读message里面的内容，我在每条message后面都附带一个随机timestamp。每一次都需要更改这个timestamp，使得newtimestamp = (oldtimestamp+1)%256，程序里加上相应举例与提示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------------------------------------+</span><br><span class="line">| PS:                                                     |</span><br><span class="line">| All message should be followed <span class="keyword">with</span> new timestamp!!!    |</span><br><span class="line">| newtimestamp = (oldtimestamp+<span class="number">1</span>)%<span class="number">256</span>                     |</span><br><span class="line">| Please don<span class="string">'t stuck with it:(                            |</span></span><br><span class="line"><span class="string">| For example, when you decrypt what Arica said like this:|</span></span><br><span class="line"><span class="string">| +--------------------+                                  |</span></span><br><span class="line"><span class="string">| |    Brooke said:    |                                  |</span></span><br><span class="line"><span class="string">| +--------------------+                                  |</span></span><br><span class="line"><span class="string">| I'</span>m Brooke.                                             |</span><br><span class="line">| timestamp:<span class="number">112</span>                                           |</span><br><span class="line">| You should encrypt this message to Arica:               |</span><br><span class="line">| +---------------------+                                 |</span><br><span class="line">| |    Say to Arica:    |                                 |</span><br><span class="line">| +---------------------+                                 |</span><br><span class="line">| I<span class="string">'m Brooke.                                             |</span></span><br><span class="line"><span class="string">| timestamp:113                                           |</span></span><br><span class="line"><span class="string">+---------------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>请大家不要太纠结timestamp的意义，这个机制是Arica和Brooke确保不被中间人攻击的机制，假设Arica和Brooke的时戳是同步的，对话中每次附加一个时戳值，通过验证时戳与当前时间是否相同来过关。但是如果是采用真正的时间的话，攻击成功的概率就更小了，所以简化一下，就生成一个固定的256位随机数。同时，中间人修改信息需要时间，并把修改后的时间替换发给另一方。这时候我们假设中间人接收并重发消息的时间代价为1s，所以我们要将时戳加一。举例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server.py</span></span><br><span class="line">messageA = questions[index]+<span class="string">b"\ntimestamp:"</span>+bytes(str((randomnum+<span class="number">1</span>)%<span class="number">256</span>),encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">messageA = adaptmessage(messageA)</span><br></pre></td></tr></table></figure>

<h4 id="Writeup样例"><a href="#Writeup样例" class="headerlink" title="Writeup样例"></a>Writeup样例</h4><p>首先，改编server.py为client.py，和服务器进行交互。这里由于交互程序变动较大，我直接通过手动输入把Arica和Brooke的密文信息传进去，等到解出明文以后手动修改timestamp。另外为了方便起见，我传递过去的公钥为1(即私钥为0)，这样的话和Brooke以及Alice的会话密钥都是1，就比较简单了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> encryption <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    keyC = <span class="number">1</span></span><br><span class="line">    keyS = <span class="number">1</span></span><br><span class="line">    keyC = long_to_bytes(keyC).rjust(<span class="number">16</span>, <span class="string">b"\x00"</span>)</span><br><span class="line">    keyS = long_to_bytes(keyS).rjust(<span class="number">16</span>, <span class="string">b"\x00"</span>)</span><br><span class="line">    cipherC = AES.new(keyC, AES.MODE_ECB)</span><br><span class="line">    cipherS = AES.new(keyS, AES.MODE_ECB)</span><br><span class="line">    <span class="keyword">for</span> _i <span class="keyword">in</span> range(<span class="number">0</span>):<span class="comment">#5</span></span><br><span class="line">        <span class="comment">#Arica说话了</span></span><br><span class="line">        s = int(say2brooke(<span class="string">"A: "</span>), <span class="number">16</span>)<span class="comment">#输入Arica说的话</span></span><br><span class="line">        s = long_to_bytes(s)</span><br><span class="line">        q = cipherC.decrypt(s)</span><br><span class="line">        print(q)</span><br><span class="line">        <span class="comment">#这里还是直接从外头输入吧</span></span><br><span class="line">        messageA = bytes(input(),encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        messageA += <span class="string">b"\n"</span></span><br><span class="line">        messageA += bytes(input(),encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        messageA = adaptmessage(messageA)</span><br><span class="line"></span><br><span class="line">        s=cipherC.encrypt(messageA)</span><br><span class="line">        print(hex(bytes_to_long(s))[<span class="number">2</span>:])<span class="comment">#对Brooke说的话</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#Brooke说话了</span></span><br><span class="line">        s = int(say2arica(<span class="string">"B: "</span>), <span class="number">16</span>)<span class="comment">#输入Brooke说的话</span></span><br><span class="line">        s = long_to_bytes(s)</span><br><span class="line">        a = cipherS.decrypt(s)</span><br><span class="line">        print(a)</span><br><span class="line">        <span class="comment">#这里还是直接从外头输入吧</span></span><br><span class="line">        messageB = bytes(input(),encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        messageB += <span class="string">b"\n"</span></span><br><span class="line">        messageB += bytes(input(),encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        messageB = adaptmessage(messageB)</span><br><span class="line">        </span><br><span class="line">        s=cipherS.encrypt(messageB)</span><br><span class="line">        print(hex(bytes_to_long(s))[<span class="number">2</span>:])<span class="comment">#对Arica说的话</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    <span class="comment">#Arica说出key了</span></span><br><span class="line">    s = int(say2brooke(<span class="string">"A: "</span>), <span class="number">16</span>)<span class="comment">#输入Arica说的话</span></span><br><span class="line">    s = long_to_bytes(s)</span><br><span class="line">    q = cipherC.decrypt(s)</span><br><span class="line">    key = q[<span class="number">17</span>:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range (len(key)):</span><br><span class="line">        <span class="keyword">if</span>(key[i:i+<span class="number">10</span>]==<span class="string">b'\ntimestamp'</span>):</span><br><span class="line">            key=key[:i]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    print(q)</span><br><span class="line">    print(key)</span><br><span class="line">    print(bytes_to_long(key))<span class="comment">#key</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>然后开始运行，运行截图如下：</p>
<p>首先收到服务器的消息:</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/1.png" alt></p>
<p>这些就是rsa的公钥，模数和泄露的私钥，先保存住，然后开始通信。</p>
<p>首先，传递的公钥都为1。然后把Arica said的内容decryption，修改timestamp后把输出给回say to Brooke。</p>
<p>服务器端界面：</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/2.png" alt="2"></p>
<p>decryption.py运行界面：</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/image-20200402131956740.png" alt="image-20200402131956740"></p>
<p>一直运行下去：</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/3.png" alt="3"></p>
<p>直到最后得到key:</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/4.png" alt="4"></p>
<p>把key的部分截取下来，转换为数字，然后根据已有的e，n，partial d来解出aeskey：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">e=<span class="number">863</span></span><br><span class="line">n = <span class="number">100518394843898371534434468452366727877002363101196571557097132988734353726584916462381290904798733002716305256677572628142627545744681541293793069726231800754314572981168235829239563613754713724345581918566947492170647540708428013292098065584617876680109166595710006367308500341766024651457023537770009981295726110940010220082434490215229951191714998895277291076151298363584672162765486380515325199053994651202708865071379999942193926154807059329464291992287421875356468218685095369057734586073271903432589401520355996027480658214090147502829069822606753125953586123331154015992246394834867237734405963056883227552074835515815968441</span></span><br><span class="line">c=<span class="number">86032824638305503499105979004374728344861493802341583733786447138684660694449673826205271902766363026345759436852747743967254218765160248630402258125202844303276381357264903281385470521070161164325276902001627351570675438339067652784355957225763207341000628151024518554862922220201109512940053316358078220681816224518400117972877854801506805929902506832781106133167532327833813179558969694268634413548545525533605595649634856393268111552838570383386406869870266457914799472663817890880697043874427042958587244568923338441053981863674366842769379075373006984522023718553749977766836594738859315852333132093474709715377682153430675891</span></span><br><span class="line">d0=<span class="number">8429433927120666131169351623736961178529851960373209550653840828920672665447032524933438956407503522388445988812739437427277858013428300926608147855795349674824173869269407061090165202002106353884034590344852857623737262477675587193006629765892565228448265429521617733861051151345083787592170864896543517637252788111</span></span><br><span class="line"></span><br><span class="line">d = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>,e):</span><br><span class="line">    <span class="keyword">print</span> k</span><br><span class="line">    X = var(<span class="string">'X'</span>)</span><br><span class="line">    results = solve_mod([e*d0*X - k*(n*X-X*X-n+X) == X], <span class="number">2</span>**<span class="number">1050</span>)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> results:</span><br><span class="line">        p0 = ZZ(x[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> is_prime(p0) <span class="keyword">and</span> gcd(n,p0)!=<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">print</span> p0</span><br><span class="line">            q0 = n//p0</span><br><span class="line">            phi=(q0<span class="number">-1</span>)*(p0<span class="number">-1</span>)</span><br><span class="line">            d = inverse_mod(e,phi)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span>(d!=<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> d</span><br><span class="line">m = pow(c,d,n)</span><br><span class="line"><span class="keyword">print</span> m</span><br></pre></td></tr></table></figure>

<p>运行结果如图：</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/5.png" alt="5"></p>
<p>得到aeskey以后解密flag，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Cryptodome.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Cryptodome.Util.number <span class="keyword">import</span> (</span><br><span class="line">    bytes_to_long,</span><br><span class="line">    long_to_bytes,</span><br><span class="line">)</span><br><span class="line">key_in_num = <span class="number">137504889148498708381160600835355727692</span></span><br><span class="line">encryptedflag = <span class="string">b'gTAmtDzEDIYdzs6j55csresodxpsKJlOVMOmzLq8/39Vm0lJZvnrGtPBW6IKUpML'</span></span><br><span class="line">c = base64.b64decode(encryptedflag)</span><br><span class="line">key = long_to_bytes(key_in_num)</span><br><span class="line">print(key)</span><br><span class="line">aes = AES.new(key, AES.MODE_ECB)</span><br><span class="line">flag = aes.decrypt(c)</span><br><span class="line">print(<span class="string">"Here is the decrypted flag: "</span>+str(flag))</span><br></pre></td></tr></table></figure>

<p>最终得到flag</p>
<p><img src="/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/6.png" alt="6"></p>
<h6 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h6><p>[1]王小云,刘明洁.格密码学研究[J].密码学报,2014,1(01):13-27.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/04/01/%E6%9E%81%E5%85%89%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%88%98%E9%98%9F%E8%80%83%E6%A0%B8%E5%AF%86%E7%A0%81%E5%AD%A6%E9%83%A8%E5%88%86%E8%80%83%E5%AF%9F%E7%82%B9%E4%B8%8E%E9%A2%98%E8%A7%A3/" data-id="ck9odqwku000ipguc5jm4cjqm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/auroralab/" rel="tag">auroralab</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/competition/" rel="tag">competition</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/project/" rel="tag">project</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Coppersmith攻击方式小结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/29/Coppersmith%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%B0%8F%E7%BB%93/" class="article-date">
  <time datetime="2020-03-29T14:54:22.000Z" itemprop="datePublished">2020-03-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/29/Coppersmith%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%B0%8F%E7%BB%93/">Coppersmith攻击方式小结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>这周本打算对各个方向有所了解，但进度并不是很如意，方向也有点分散。中间因为有点疲惫松懈了两天，后面有了精神以后首先写好了所有作业，然后做了几道CTF密码学题目，然后跟着就开始系统的小结一些密码学攻击方式，再接着就看起了密码学和人工智能安全相关的论文。论文还没细看，几道题目比较老套也没有什么太有新意的地方。但是毕竟立下了flag要一周写一篇文章，那么就只能把网上学习到的对Coppersmith的攻击方式完整地总结一下了。</em></p>
<h1 id="CopperSmith攻击"><a href="#CopperSmith攻击" class="headerlink" title="CopperSmith攻击"></a>CopperSmith攻击</h1><p>CopperSmith攻击的种类真的很多，所以总是觉得自己归纳的不够彻底</p>
<h4 id="一道新的例题——p的高位和地位泄露"><a href="#一道新的例题——p的高位和地位泄露" class="headerlink" title="一道新的例题——p的高位和地位泄露"></a>一道新的例题——p的高位和地位泄露</h4><h3 id="Securinets-CTF-Quals-2020-Destruction"><a href="#Securinets-CTF-Quals-2020-Destruction" class="headerlink" title="Securinets CTF Quals 2020 - Destruction"></a><em>Securinets CTF Quals 2020 - Destruction</em></h3><p>题目中提及MSB寓意即最高比特位，LSB即最低比特位，根据铜匠攻击即可,sage脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">size = <span class="number">512</span></span><br><span class="line">sizep=<span class="number">256</span></span><br><span class="line">knownbits= <span class="number">134</span></span><br><span class="line">N=<span class="number">14086160291425342283520344380411983364812792954622400251334758082442316624175006850950987254617679940795136231914925367368535278968830499182004816257654049</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#we need to define an polynomial == 0 (mod p) that gives us the missing part (x)</span></span><br><span class="line"><span class="comment"># f_p(x) = x*2**(knownbits/2) + p_msb + p_lsb</span></span><br><span class="line"><span class="comment"># it's not monic so we need to divide by 2**(knownbits/2)</span></span><br><span class="line"><span class="comment"># set R = 2**(knownbits/2) and invert it modulo N</span></span><br><span class="line"></span><br><span class="line">R = <span class="number">2</span>**(knownbits/<span class="number">2</span>)<span class="comment">#从第68位开始测试</span></span><br><span class="line">invR = inverse_mod(R,N)</span><br><span class="line"><span class="comment">#补齐两边</span></span><br><span class="line">p_msb = <span class="number">251000163339563476196</span> &lt;&lt; (sizep-knownbits/<span class="number">2</span><span class="number">-1</span>)</span><br><span class="line">p_lsb=int(<span class="string">'2567fcb8c35e6dc63'</span>,<span class="number">16</span>)</span><br><span class="line"><span class="comment">#setup coppersmith</span></span><br><span class="line">F.&lt;x&gt; = PolynomialRing(Zmod(N))</span><br><span class="line"><span class="comment">#define the poly in x modulo p</span></span><br><span class="line">f = x + (p_msb+p_lsb)*invR</span><br><span class="line"><span class="comment">#solve it</span></span><br><span class="line">x0 = f.small_roots(X=<span class="number">2</span>^(sizep-knownbits)<span class="number">-1</span>, beta=<span class="number">0.44</span>, epsilon=<span class="number">1</span>/<span class="number">64</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> (<span class="string">"reconstructed p: &#123;:x&#125;"</span>.format(Integer(x0*R)+p_msb+p_lsb))</span><br></pre></td></tr></table></figure>

<p>在这道题目中，p的高位和地位比特都被泄露，可以解出rsa明文。</p>
<h4 id="引申与补充"><a href="#引申与补充" class="headerlink" title="引申与补充"></a>引申与补充</h4><p>除了上述例题所述的情况外，我目前至少见过四种coppersmith攻击模式。</p>
<h4 id="2019强网杯-RSA-Coppersmith"><a href="#2019强网杯-RSA-Coppersmith" class="headerlink" title="2019强网杯-RSA-Coppersmith"></a><em>2019强网杯-RSA-Coppersmith</em></h4><p>1.challenge 1</p>
<p><strong>已知明文的高位，是Stereotyped messages攻击 或 Lattice based attacks</strong> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="comment">#输入n  </span></span><br><span class="line">e = <span class="number">3</span></span><br><span class="line">m = randrange(n)</span><br><span class="line">c = pow(m, e, n)</span><br><span class="line">beta = <span class="number">1</span></span><br><span class="line">epsilon = beta^<span class="number">2</span>/<span class="number">7</span></span><br><span class="line">nbits = n.nbits()</span><br><span class="line">kbits = floor(nbits*(beta^<span class="number">2</span>/e-epsilon))</span><br><span class="line">mbar = m &amp; (<span class="number">2</span>^nbits<span class="number">-2</span>^kbits)</span><br><span class="line">c = <span class="number">0x1f6f6a8e61f7b5ad8bef738f4376a96724192d8da1e3689dec7ce5d1df615e0910803317f9bafb6671ffe722e0292ce76cca399f2af1952dd31a61b37019da9cf27f82c3ecd4befc03c557efe1a5a29f9bb73c0239f62ed951955718ac0eaa3f60a4c415ef064ea33bbd61abe127c6fc808c0edb034c52c45bd20a219317fb75</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">print</span> <span class="string">"upper %d bits (of %d bits) is given"</span> % (nbits-kbits, nbits)</span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">f = (mbar + x)^e - c </span><br><span class="line"><span class="keyword">print</span> m</span><br><span class="line"> </span><br><span class="line">x0 = f.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">1</span>)[<span class="number">0</span>]  <span class="comment"># find root &lt; 2^kbits with factor = n1</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">print</span> mbar + x0</span><br></pre></td></tr></table></figure>

<p>2.challenge 2</p>
<p><strong>已知p的高位，Factoring with High Bits Known</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">0x5894f869d1aecee379e2cb60ff7314d18dbd383e0c9f32e7f7b4dc8bd47535d4f3512ce6a23b0251049346fede745d116ba8d27bcc4d7c18cfbd86c7d065841788fcd600d5b3ac5f6bb1e111f265994e550369ddd86e20f615606bf21169636d153b6dfee4472b5a3cb111d0779d02d9861cc724d389eb2c07a71a7b3941da7dL</span></span><br><span class="line">p_fake = <span class="number">0x5d33504b4e3bd2ffb628b5c447c4a7152a9f37dc4bcc8f376f64000fa96eb97c0af445e3b2c03926a4aa4542918c601000000000000000000000000000000000L</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">#pbits = 2048</span></span><br><span class="line">pbits = p_fake.nbits()</span><br><span class="line"><span class="comment">#kbits = 900</span></span><br><span class="line">kbits = <span class="number">128</span>  <span class="comment">#p失去的低位</span></span><br><span class="line">pbar = p_fake &amp; (<span class="number">2</span>^pbits<span class="number">-2</span>^kbits)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"upper %d bits (of %d bits) is given"</span> % (pbits-kbits, pbits)</span><br><span class="line"> </span><br><span class="line">PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">f = x + pbar</span><br><span class="line"> </span><br><span class="line">x0 = f.small_roots(X=<span class="number">2</span>^kbits, beta=<span class="number">0.4</span>)[<span class="number">0</span>]  <span class="comment"># find root &lt; 2^kbits with factor &gt;= n^0.3</span></span><br><span class="line">p= x0 + pbar</span><br><span class="line"><span class="keyword">print</span> p</span><br></pre></td></tr></table></figure>

<p>3.challenge 3</p>
<p><strong>已知私钥的512位的低位 Partial Key Exposure Attack(部分私钥暴露攻击)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partial_p</span><span class="params">(p0, kbits, n)</span>:</span></span><br><span class="line">    PR.&lt;x&gt; = PolynomialRing(Zmod(n))</span><br><span class="line">    nbits = n.nbits()</span><br><span class="line">    f = <span class="number">2</span>^kbits*x + p0 </span><br><span class="line">    f = f.monic()</span><br><span class="line">    roots = f.small_roots(X=<span class="number">2</span>^(nbits//<span class="number">2</span>-kbits), beta=<span class="number">0.3</span>)  <span class="comment"># find root &lt; 2^(nbits//2-kbits) with factor &gt;= n^0.3</span></span><br><span class="line">    <span class="keyword">if</span> roots:</span><br><span class="line">        x0 = roots[<span class="number">0</span>]</span><br><span class="line">        p = gcd(<span class="number">2</span>^kbits*x0 + p0, n)</span><br><span class="line">        <span class="keyword">return</span> ZZ(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_p</span><span class="params">(d0, kbits, e, n)</span>:</span></span><br><span class="line">    X = var(<span class="string">'X'</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> xrange(<span class="number">1</span>, e+<span class="number">1</span>):</span><br><span class="line">        results = solve_mod([e*d0*X - k*X*(n-X+<span class="number">1</span>) + k*n == X], <span class="number">2</span>^kbits)</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> results:</span><br><span class="line">            p0 = ZZ(x[<span class="number">0</span>])</span><br><span class="line">            p = partial_p(p0, kbits, n)</span><br><span class="line">            <span class="keyword">if</span> p:</span><br><span class="line">                <span class="keyword">return</span> p</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    n = <span class="number">0xd463feb999c9292e25acd7f98d49a13413df2c4e74820136e739281bb394a73f2d1e6b53066932f50a73310360e5a5c622507d8662dadaef860b3266222129fd645eb74a0207af9bd79a9794f4bd21f32841ce9e1700b0b049cfadb760993fcfc7c65eca63904aa197df306cad8720b1b228484629cf967d808c13f6caef94a9</span></span><br><span class="line">    e = <span class="number">3</span></span><br><span class="line">    d = <span class="number">0x603d033f2ef6c759aec839f132a45215fc8a635b757f3951a731fe60bc6729b3bcf819b57abfcaba3a93e9edef766c0d499cad3f7adb306bcf1645cfb63400e3</span></span><br><span class="line">    beta = <span class="number">0.5</span></span><br><span class="line">    epsilon = beta^<span class="number">2</span>/<span class="number">7</span></span><br><span class="line">    nbits = n.nbits()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"nbits:%d:"</span>%(nbits) </span><br><span class="line">    <span class="comment">#kbits = floor(nbits*(beta^2+epsilon))</span></span><br><span class="line">    kbits = nbits - d.nbits()<span class="number">-1</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"kbits:%d"</span>%(kbits)</span><br><span class="line">    d0 = d &amp; (<span class="number">2</span>^kbits<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"lower %d bits (of %d bits) is given"</span> % (kbits, nbits)</span><br><span class="line">    p = find_p(d0, kbits, e, n </span><br><span class="line">    <span class="keyword">print</span> <span class="string">"found p: %d"</span> % p</span><br><span class="line">    q = n//p</span><br><span class="line">    <span class="keyword">print</span> d</span><br><span class="line"><span class="keyword">print</span> inverse_mod(e, (p<span class="number">-1</span>)*(q<span class="number">-1</span>))</span><br></pre></td></tr></table></figure>

<h4 id="私钥泄露"><a href="#私钥泄露" class="headerlink" title="私钥泄露"></a><em>私钥泄露</em></h4><p>这部分学习的是在<a href="https://ctftime.org/tasks/?tags=crypto&hidden-tags=crypto" target="_blank" rel="noopener">网上</a>看到的一道题目的一篇<a href="https://github.com/p4-team/ctf/tree/master/2019-09-21-dragonctf/rsachained" target="_blank" rel="noopener">wp</a>写的，都说密钥时现代密码的弱点，所以rsa私钥部分泄露原来也可以导致对rsa的铜匠攻击！这部分的方程倒不难推算，因此我也出了一道和私钥泄露有关的题目,<a href="../极光实验室战队考核密码学部分考察点与题解">题解</a>也在博客里。这里把sage脚本也放出来吧。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">e=<span class="number">863</span></span><br><span class="line">n = <span class="number">100518394843898371534434468452366727877002363101196571557097132988734353726584916462381290904798733002716305256677572628142627545744681541293793069726231800754314572981168235829239563613754713724345581918566947492170647540708428013292098065584617876680109166595710006367308500341766024651457023537770009981295726110940010220082434490215229951191714998895277291076151298363584672162765486380515325199053994651202708865071379999942193926154807059329464291992287421875356468218685095369057734586073271903432589401520355996027480658214090147502829069822606753125953586123331154015992246394834867237734405963056883227552074835515815968441</span></span><br><span class="line">c=<span class="number">86032824638305503499105979004374728344861493802341583733786447138684660694449673826205271902766363026345759436852747743967254218765160248630402258125202844303276381357264903281385470521070161164325276902001627351570675438339067652784355957225763207341000628151024518554862922220201109512940053316358078220681816224518400117972877854801506805929902506832781106133167532327833813179558969694268634413548545525533605595649634856393268111552838570383386406869870266457914799472663817890880697043874427042958587244568923338441053981863674366842769379075373006984522023718553749977766836594738859315852333132093474709715377682153430675891</span></span><br><span class="line">d0=<span class="number">8429433927120666131169351623736961178529851960373209550653840828920672665447032524933438956407503522388445988812739437427277858013428300926608147855795349674824173869269407061090165202002106353884034590344852857623737262477675587193006629765892565228448265429521617733861051151345083787592170864896543517637252788111</span></span><br><span class="line"></span><br><span class="line">d = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>,e):</span><br><span class="line">    <span class="keyword">print</span> k</span><br><span class="line">    X = var(<span class="string">'X'</span>)</span><br><span class="line">    results = solve_mod([e*d0*X - k*(n*X-X*X-n+X) == X], <span class="number">2</span>**<span class="number">1050</span>)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> results:</span><br><span class="line">        p0 = ZZ(x[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">if</span> is_prime(p0) <span class="keyword">and</span> gcd(n,p0)!=<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">print</span> p0</span><br><span class="line">            q0 = n//p0</span><br><span class="line">            phi=(q0<span class="number">-1</span>)*(p0<span class="number">-1</span>)</span><br><span class="line">            d = inverse_mod(e,phi)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span>(d!=<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> d</span><br><span class="line">m = pow(c,d,n)</span><br><span class="line"><span class="keyword">print</span> m</span><br></pre></td></tr></table></figure>

<h4 id="其他题目"><a href="#其他题目" class="headerlink" title="其他题目"></a><em>其他题目</em></h4><p>除此以外，印象中还存在另外一些coppersmith题目，印象中我把所有解方程有关的题目都当成coppersmith了。我新人赛的时候也心血来潮自创了一题，打算放到校赛用。反正最基础的办法就是：<strong>找齐足够的方程，代入消元求解。</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/29/Coppersmith%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E5%B0%8F%E7%BB%93/" data-id="ck9odqwin0000pguc4gut8i7t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/exploration/" rel="tag">exploration</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-安卓反混淆软件探索-deobf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/" class="article-date">
  <time datetime="2020-03-19T13:48:03.000Z" itemprop="datePublished">2020-03-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/">安卓反混淆软件探索-deobf</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们的大创项目其实是分两方面进行的，一方面，我们从代码混淆的角度比较各种软件对安卓程序的加固能力；另一方面，我们着重针对OLLVM进行反混淆测试。OLLVM集成了代码混淆的几种最基本的方法：控制流平坦化，虚假控制流，指令替代等三种方式；其中控制流平坦化和虚假控制流可以混淆各个基本块之间的执行顺序，使得程序的执行流程更难读懂，但是它们有一个致命的攻破方法——符号执行。这不仅成为了每一位资深逆向人员必备的技能，而且也逐渐被开发成了自动化反混淆工具。目前市面上开源的自动化反混淆工具很少，有一款是<a href="https://github.com/CalebFenton/simplify" target="_blank" rel="noopener">针对安卓应用的simplify</a> ，另外我在github上面搜寻了OLLVM的反混淆软件，排除大部分无用的项目，最终只发现了这两个有实际价值的项目。</p>
<h4 id="ollvm-de-fla"><a href="#ollvm-de-fla" class="headerlink" title="ollvm_de_fla"></a><a href="https://github.com/sfwishes/ollvm_de_fla" target="_blank" rel="noopener">ollvm_de_fla</a></h4><p>针对控制流平坦化的反混淆工具，不足之处就是只适用于带thumb2指令的ios macho格式文件，因此它的平台普适性不高，应用范围极其窄。 该项目于两年前便停止更新。</p>
<h4 id="deobf"><a href="#deobf" class="headerlink" title="deobf"></a><a href="https://github.com/maiyao1988/deobf" target="_blank" rel="noopener">deobf</a></h4><p>deobf主要也是针对控制流平坦化这种主流的代码混淆方式。相比ollvm_de_fla，deobf的优势多很多。首先，这是一个新兴项目，创建于大约四个月前，在四天前还曾发布了重大更新。另外，这个项目适用于linux和windows等大众平台，可以不限于thumb指令的使用，有着广泛的应用前景。在项目的说明文档中，很清楚的说明了项目的拷贝方法，安装方法和运行参数。<strong>不仅可以反混淆一般的so文件，也可以针对性的处理抖音的libcms.so文件。</strong></p>
<p>但是这个项目依然有着自己的不足，只适用于python3.7版本，更低级的版本不能兼容。</p>
<h2 id="下载与安装"><a href="#下载与安装" class="headerlink" title="下载与安装"></a>下载与安装</h2><p>由于deobf需要python3.7环境支持，所以需要下载python3.7，在linux下默认的环境没有python3.7，升级步骤可以参考一篇不错的<a href="https://blog.csdn.net/u014775723/article/details/85213793" target="_blank" rel="noopener">文章</a> 。后来在windows下也安装了一个，按照<a href="https://github.com/maiyao1988/deobf" target="_blank" rel="noopener">项目链接</a>下第二步的详细做法完成即可。但是这里建议把32位和64位的keystone都下下来（当然32位的比较重要）。如果运行报错很有可能是dll的原因，两个dll混搭着用应该就没有问题。</p>
<h2 id="deobf反混淆原理初探"><a href="#deobf反混淆原理初探" class="headerlink" title="deobf反混淆原理初探"></a>deobf反混淆原理初探</h2><h4 id="基于OLLVM的反混淆框架的实现"><a href="#基于OLLVM的反混淆框架的实现" class="headerlink" title="基于OLLVM的反混淆框架的实现"></a>基于OLLVM的反混淆框架的实现</h4><p>一般的反混淆软件都会有以下几个模块:</p>
<p>1）<strong>基本块识别模块</strong> ：识别出有用块和无用块。经 OLLVM 控制流平展化混 淆的程序中会增加很多无用的基本块以混淆程序逻辑，这就 需要设计有效的基本块识别算法，找出有用的基本块和无用 的基本块。</p>
<p> 2）<strong>与程序执行流程相关模块</strong> ：确定有用块之间的前后关系，得到真实有效的程序执行路径，因为混淆程序中的很多基本块跳转逻辑并不是程序的实际执行流程。 一般采用符号执行技术。</p>
<p>3）<strong>指令修复模块</strong> ：修复二进制程序。在使用 NOP 指令填充无用基本块 后，为使程序正常运行，我们需要对跳转指令的跳转偏移量 进行修正；同时，还需要将 cmov 条件传送指令改写成相应 的条件跳转指令，并在其后添加一条 jmp 指令，使其跳向另 一分支。 </p>
<p><em>参考文献</em></p>
<p><em>[1]肖顺陶,周安民,刘亮,贾鹏,刘露平.<a href="http://kns.cnki.net/kcms/detail/51.1307.TP.20180319.1531.012.html." target="_blank" rel="noopener">基于符号执行的OLLVM反混淆框架</a>[J/OL].计算机应用:1-6[2020-03-22].</em></p>
<p><em>[2]肖顺陶,周安民,刘亮,贾鹏,刘露平.基于符号执行的底层虚拟机混淆器反混淆框架[J].计算机应用,2018,38(06):1745-1750.</em></p>
<h4 id="通过IDA调试确定基本块的前后关系"><a href="#通过IDA调试确定基本块的前后关系" class="headerlink" title="通过IDA调试确定基本块的前后关系"></a>通过IDA调试确定基本块的前后关系</h4><p>这是deobf的一个突出特点，它是根据一个IDA-python脚本直接对软件执行调试，通过这里确定程序的执行流程。<a href="**https://github.com/maiyao1988/IDAScripts/blob/master/trace.py**">参考脚本 </a>。</p>
<p>这也就意味着，和传统采用的符号执行不同，<strong>deobf不需要虚拟执行的结果，而是实打实的进行了调试。但是这样的确定就是不能抗动态调试。万一一个程序加入了很多的动态调试函数，那么讲给deobf的运行效果带来很大的挑战。</strong></p>
<h2 id="deobf反混淆效果"><a href="#deobf反混淆效果" class="headerlink" title="deobf反混淆效果"></a>deobf反混淆效果</h2><h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p>由于deobf的软件的基本框架和上述论文中的反混淆框架在思路上完全一致，除了确定基本块以外其他方面的实现方案上大致相同，因此在这里先引用一下论文中有关混淆效果的数据，如下：</p>
<p><img src="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/image-20200322231048178.png" alt="image-20200322231048178"></p>
<p><img src="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/image-20200322231036631.png" alt="image-20200322231036631"></p>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>为了验证OLLVM的反混淆效果是否真的和论文一致，我使用项目中提供给测试使用的so文件进行混淆，这个项目运用了</p>
<p>ida查看混淆后的控制流图，十分复杂庞大：</p>
<p><img src="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/image-20200320000323204.png" alt="image-20200320000323204"></p>
<p>而反编译后的伪C代码如下，十分复杂，出现多个嵌套的while循环和if分支语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">JNI_OnLoad</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// r6</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// r11</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v4; <span class="comment">// r5</span></span><br><span class="line">  <span class="keyword">bool</span> v5; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [sp+8h] [bp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [sp+Ch] [bp-2Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [sp+10h] [bp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// [sp+14h] [bp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [sp+18h] [bp-20h]</span></span><br><span class="line"></span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  v1 = (*(<span class="keyword">int</span> (**)(<span class="keyword">void</span>))(*(_DWORD *)a1 + <span class="number">24</span>))();</span><br><span class="line">  v2 = <span class="number">189500648</span>;</span><br><span class="line">  v8 = v1;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_3:</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = v1;</span><br><span class="line">      v4 = v2;</span><br><span class="line">      <span class="keyword">if</span> ( v2 &gt; <span class="number">941059666</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v2 &gt; <span class="number">-526232813</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v2 == <span class="number">-526232812</span> )</span><br><span class="line">        &#123;</span><br><span class="line">LABEL_2:</span><br><span class="line">          v2 = <span class="number">1535406375</span>;</span><br><span class="line">          v1 = <span class="number">-1</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v2 == <span class="number">189500648</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v2 = <span class="number">2058077166</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v8 )</span><br><span class="line">            v2 = <span class="number">1482189424</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v2 = <span class="number">1535406375</span>;</span><br><span class="line">        v1 = <span class="number">65540</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v4 == <span class="number">-1125020146</span> )</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        v5 = v4 == <span class="number">-724953770</span>;</span><br><span class="line">LABEL_10:</span><br><span class="line">        v1 = v3;</span><br><span class="line">        v2 = v4;</span><br><span class="line">        <span class="keyword">if</span> ( v5 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= <span class="number">1535406374</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v2 == <span class="number">941059667</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = (*(<span class="keyword">int</span> (__fastcall **)(<span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">char</span> *))(*(_DWORD *)v9 + <span class="number">24</span>))(v9, <span class="string">"com/douyu/lib/http/JniMakeUrl"</span>);</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">1448204801</span>; ; i = <span class="number">1422645221</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v2 = <span class="number">-1125020146</span>;</span><br><span class="line">          <span class="keyword">if</span> ( i &gt; <span class="number">1398646745</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">LABEL_33:</span><br><span class="line">          <span class="keyword">while</span> ( i == <span class="number">193258894</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v5 = (*(<span class="keyword">int</span> (__fastcall **)(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">char</span> **, <span class="keyword">signed</span> <span class="keyword">int</span>))(*(_DWORD *)v9 + <span class="number">860</span>))(v9, v11, off_45004, <span class="number">7</span>) == <span class="number">0</span>;</span><br><span class="line">            i = <span class="number">-686378191</span>;</span><br><span class="line">            <span class="keyword">if</span> ( !v5 )</span><br><span class="line">              i = <span class="number">-986576434</span>;</span><br><span class="line">            <span class="keyword">if</span> ( i &gt; <span class="number">1398646745</span> )</span><br><span class="line">            &#123;</span><br><span class="line">LABEL_36:</span><br><span class="line">              <span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">while</span> ( i == <span class="number">1448204801</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  i = <span class="number">193258894</span>;</span><br><span class="line">                  <span class="keyword">if</span> ( !v11 )</span><br><span class="line">                    i = <span class="number">1398646746</span>;</span><br><span class="line">                  <span class="keyword">if</span> ( i &lt;= <span class="number">1398646745</span> )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( i == <span class="number">1398646746</span> )</span><br><span class="line">                &#123;</span><br><span class="line">LABEL_32:</span><br><span class="line">                  i = <span class="number">1422645221</span>;</span><br><span class="line">                  v2 = <span class="number">-724953770</span>;</span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> ( i == <span class="number">1422645221</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v1 = v3;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">LABEL_47:</span><br><span class="line">                ;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( i == <span class="number">-986576434</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">          <span class="keyword">if</span> ( i != <span class="number">-686378191</span> )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_47;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v5 = v2 == <span class="number">1482189424</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v2 != <span class="number">2058077166</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = <span class="number">941059667</span>;</span><br><span class="line">    v9 = v10;</span><br><span class="line">    <span class="keyword">if</span> ( !v10 )</span><br><span class="line">      v2 = <span class="number">-526232812</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v2 != <span class="number">1535406375</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  result = _stack_chk_guard - v12;</span><br><span class="line">  <span class="keyword">if</span> ( _stack_chk_guard == v12 )</span><br><span class="line">    result = v3;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行如下反混淆指令，反混淆其中的JNI_Onload函数：</p>
<p><code>python deobf.py libmakeurl2.4.9.so url.so ins-url.trc 0x0000342C 0x00003668 1</code></p>
<p>以下是对各个参数的注释：</p>
<p>待处理的混淆文件：libmakeurl2.4.9.so</p>
<p>反混淆后输出的文件：url.so</p>
<p> 通过ida调试时产生的目标函数的跟踪文件（可以跟踪关键指令或函数） ：ins-url.trc</p>
<p>混淆代码段起始部分偏移：0x0000342C（JNI_Onload函数开头）</p>
<p>混淆代码段结束部分偏移：0x00003668（JNI_Onload函数结尾）</p>
<p>目标函数是否是thumb：是</p>
<p>反混淆后的控制流图，程序执行流程变得十分清晰：</p>
<p><img src="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/image-20200320000158559.png" alt="image-20200320000158559"></p>
<p>反混淆后的函数也变得简短易懂：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">JNI_OnLoad</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// r11</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [sp+10h] [bp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [sp+14h] [bp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [sp+18h] [bp-20h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  (*(<span class="keyword">void</span> (**)(<span class="keyword">void</span>))(*(_DWORD *)a1 + <span class="number">24</span>))();</span><br><span class="line">  v2 = v4;</span><br><span class="line">  v5 = (*(<span class="keyword">int</span> (__fastcall **)(<span class="keyword">int</span>))(*(_DWORD *)v4 + <span class="number">24</span>))(v4);</span><br><span class="line">  (*(<span class="keyword">int</span> (__fastcall **)(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">char</span> **, <span class="keyword">signed</span> <span class="keyword">int</span>))(*(_DWORD *)v2 + <span class="number">860</span>))(v2, v5, off_45004, <span class="number">7</span>);</span><br><span class="line">  result = _stack_chk_guard - v6;</span><br><span class="line">  <span class="keyword">if</span> ( _stack_chk_guard == v6 )</span><br><span class="line">    result = v1;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="其他OLLVM反混淆软件常用技术"><a href="#其他OLLVM反混淆软件常用技术" class="headerlink" title="其他OLLVM反混淆软件常用技术"></a>其他OLLVM反混淆软件常用技术</h2><h4 id="符号执行"><a href="#符号执行" class="headerlink" title="符号执行"></a>符号执行</h4><p>deobf的反混淆主要借助与符号执行技术，符号执行技术的核心思想是使用符号值来表示程序的输入数据，并将程序的运算过程逐指令或逐语句地转换为数学表达式，在CFG的基础上生成符号执行树，并为每一条路径建立一系列以输入数据为变量的符号表达式。在符号执行过程中，每当遇到判断与跳转语句时，deobf便会将当前执行路径的路径约束收集到该路径的约束集合中。通过使用约束求解器对约束集合进行求解，可以得到该条路径的可达性：如果约束求解的结果有解，表示该条路径可达，否则表示该条路径不可达，在时间与计算资源足够的理想情况下，符号执行能够遍历目标程序的所有路径并判断其可达性。</p>
<p>其中，路径约束是指程序分支指令中与输入符号相关的分支条件的取值，是一系列不具有量词的布尔型公式。而路径约束集合则被用来存储每一条程序路径上收集到的约束，用“与”操作进行连接。</p>
<p>借用软件安全课程的图片，对于下图示例程序1：</p>
<p><img src="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/image-20200319232030997.png" alt="image-20200319232030997"></p>
<p>首先画出控制流图，切割基本块。然后计算得函数外部的输入变量数为2，我们只需要设置两个输入变量X,Y。程序中的所有都用与X,Y相关的式子代替。</p>
<p><img src="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/image-20200319233648011.png" alt="image-20200319233648011"></p>
<p>然后进入函数顺序执行第2-4行，不出现分叉，在第五行代码时，由于是判断语句，符号执行树出现分支，满足分支条件的作为左子树，不满足的作为右子树，左右子树又继续根据路径约束进一步细化，出现更多分支。最终扩展出的符号执行树如图：</p>
<p><img src="/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/image-20200319233036906.png" alt="image-20200319233036906"></p>
<p>最后，通过将X、Y变量代入，计算叶子节点的约束集合是否为真，则可以知道哪些路径是可达的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/19/%E5%AE%89%E5%8D%93%E5%8F%8D%E6%B7%B7%E6%B7%86%E8%BD%AF%E4%BB%B6%E6%8E%A2%E7%B4%A2-deobf/" data-id="ck9odqwkv000kpguc47m7cghc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/project/" rel="tag">project</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="w-记一次安卓代码加固研究过程" class="article article-type-w" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/" class="article-date">
  <time datetime="2020-03-13T03:53:13.000Z" itemprop="datePublished">2020-03-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/">记一次安卓代码加固软件的测试过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在大创项目的实践中，我们对市面上的一些安卓代码加固软件进行了采集，经过搜集，发现了几类代码加固方法并分组进行研究。我发现很多代码加固软件都是对java字节码进行混淆与加固，另外一些则选择对原生语言和so文件进行加固，而我打算研究的这一款软件，则是对资源文件进行加固，它就是<a href="https://github.com/shwenzhang/AndResGuard/blob/master/README.zh-cn.md" target="_blank" rel="noopener">AndResGuard</a>。</p>
<h3 id="混淆原理"><a href="#混淆原理" class="headerlink" title="混淆原理"></a>混淆原理</h3><p>大致上来说就是apk在调用资源的时候不是通过资源名来调用的，而是通过一个资源ID值来调用的，因此资源名和资源ID存在一种映射关系，保存在 resources.arsc 中。而由于资源名是一种相对独立的存在方式，仅仅是为了源码的易读性，所以可以用用更短的资源名取代，从而减少apk文件的体积；而新的代号没有任何语义上的可读性，所以可以达到混淆的目的。而且由于这种映射关系是独立于安卓编译过程的，所以我们可以在整个apk的基础上进行操作，通过实现对apk的解压并修改资源文件和 resources.arsc 进行混淆。</p>
<p>项目贡献者的说明文章见<a href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=208135658&idx=1&sn=ac9bd6b4927e9e82f9fa14e396183a8f#rd" target="_blank" rel="noopener">这里</a>。</p>
<h3 id="混淆过程"><a href="#混淆过程" class="headerlink" title="混淆过程"></a>混淆过程</h3><p>为了统一研究对象，采用的混淆软件是我第六次安卓作业后生成的apk文件:</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/1.png" alt></p>
<p>下载完整个项目以后，最重要的文件是箭头所指的jar文件，这个其实就是源码编译以后的可执行文件了：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/2.png" alt></p>
<p>不过还需要输入一些参数才可以运行，包括待混淆apk，混淆配置文件，输出路径，甚至可以加入签名库的路径。</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>输入参数前，先更改一下混淆配置文件，打开config.xml后，我根据实际研究的情况作了如下更改。</p>
<p>1.<strong>设置不采用7z压缩。</strong>显然，7z压缩是这个软件集成的外部功能，一方面能更加减小程序的空间，另一方面也可以提高程序表观上的复杂程度。但是需要指出的是，7z压缩在AndResGuard中是一个比较独立的组成部分，首先在技术原理和实现方式上就有很大的不同，而且7z压缩更像是对混淆后资源文件的一种打包技术，就像是把安卓源码混淆后再进行打包一样，有着独立的压缩和解压方法，并不涉及任何混淆的思想，也不需要任何的反混淆技术。而如果采用7z压缩后再进行分析，就相当于采用两种技术加固软件后和其他采用一种技术加固软件的方法进行优劣比较，这种方法是不合理的。</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/3.png" alt></p>
<p>2.<strong>设置不采用签名。</strong>由于混淆前的软件没有采用签名技术，因此作为对照组，混淆后的软件也不应该采用签名技术。</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/4.png" alt></p>
<h4 id="混淆"><a href="#混淆" class="headerlink" title="混淆"></a>混淆</h4><p>AndResGuard的混淆是针对整个文件进行的，只需要输入如下参数即可：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/5.png" alt></p>
<p>耗时不到5秒即完成。</p>
<h4 id="混淆效果测试"><a href="#混淆效果测试" class="headerlink" title="混淆效果测试"></a>混淆效果测试</h4><p>混淆后，从程序体积，代码可读性等两方面分析混淆效果，主要出现了如下变化：</p>
<p>1.<strong>体积变小。</strong>混淆后生成了另一个apk，把两个apk放在一起，可以明显的看到混淆后的apk文件体积变小，从2511kb变为2104kb。</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/6.png" alt></p>
<p>2.<strong>资源文件的可读性变复杂，资源名的失去了原有的语义。</strong>采用apk-tool对混淆前后的apk文件进行反编译。这款软件的优势在于可以把apk的文件转变为smali中间代码和资源文件源码，把 resources.arsc还原为原来的res文件夹。通过Android Studio对比整个res文件夹的结构，我们可以发现如下变化：</p>
<p>(1)资源名称出现变化</p>
<p>资源文件总量不变，名称被更短的代号取代。</p>
<p>以Layout文件夹为例，混淆前的前四个资源文件名称如下：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/7.png" alt></p>
<p>而混淆后的资源文件名则被更简短的代号取代。以Layout文件夹为例，混淆后的前四个资源文件名称如下：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/8.png" alt></p>
<p>点击混淆前和混淆后最上方的文件，发现文件的内容已经不再对应，所以可以认为这是一种无规律的命名，打乱了各个资源文件名的对应关系。</p>
<p>（2）资源文件中所有的引用名都被修改</p>
<p>在res文件夹下所有的所有资源引用中，资源名都被更改，以res\values\attrs.xml为例，混淆前我们可以获取完整的资源名称，如图：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/9.png" alt></p>
<p>而混淆后，所有的资源名都变为了简短的代号。</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/10.png" alt></p>
<p>3.<strong>值得注意的是，源代码中所有的内容都不曾被改变，这说明AndResGuard不依赖于smali代码和编译过程。</strong>首先把apk的后缀改为rar并解压，取出dex文件采用dex2jar进行反编译，再使用jd-gui打开生成的jar文件，我们可以发现，混淆前的jar包和混淆后的jar包是完全一致的，以MainActivity为例，混淆前后完全看不出任何区别。混淆前代码如下：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/11.png" alt></p>
<p>混淆后代码如下：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/12.png" alt></p>
<h4 id="运行性能测试"><a href="#运行性能测试" class="headerlink" title="运行性能测试"></a>运行性能测试</h4><p>首次运行混淆后的程序时，出现如下报错：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/13.png" alt></p>
<p>查阅<a href="https://blog.csdn.net/almosti/article/details/88586873" target="_blank" rel="noopener">资料</a>后猜测报错原因.</p>
<p>但测试了一遍ARM框架的软件还是不行，那么我推测，报错的原因很有可能是因为资源文件被打乱，导致虚拟机无法识别。我尝试用华为手机下载，里面的报错是：该安装包未包含任何证书，因此我可能需要考虑一下运行参数的问题了。但是在测试了除了签名之外的参数后，发现依然无法运行。但是用.android目录下的debug.keystore签名时出现报错，报错情况如下：</p>
<p><img src="/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/14.png" alt></p>
<p>目前暂不知错误，正在分析中。<strong>希望大家可以帮帮我！</strong>不知道是否需要其他什么文件呢。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>其实AndResGuard就是对apk包的资源 resources.arsc进行更改，使得原有的资源文件中的资源名变得更加简短而不可读。这增加了安卓逆向人员的分析难度，实现了代码混淆。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/13/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%89%E5%8D%93%E4%BB%A3%E7%A0%81%E5%8A%A0%E5%9B%BA%E7%A0%94%E7%A9%B6%E8%BF%87%E7%A8%8B/" data-id="ck9odqwlt0017pguc83jedbl5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/project/" rel="tag">project</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/auroralab/" rel="tag">auroralab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/competition/" rel="tag">competition</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diary/" rel="tag">diary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exploration/" rel="tag">exploration</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/introduction/" rel="tag">introduction</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/project/" rel="tag">project</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/study/" rel="tag">study</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/auroralab/" style="font-size: 13.33px;">auroralab</a> <a href="/tags/competition/" style="font-size: 13.33px;">competition</a> <a href="/tags/diary/" style="font-size: 13.33px;">diary</a> <a href="/tags/exploration/" style="font-size: 10px;">exploration</a> <a href="/tags/introduction/" style="font-size: 10px;">introduction</a> <a href="/tags/project/" style="font-size: 20px;">project</a> <a href="/tags/study/" style="font-size: 16.67px;">study</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/04/30/%E5%9F%BA%E4%BA%8E%E9%97%A8%E9%99%90%E6%96%B9%E6%A1%88%E7%9A%84%E6%9D%A1%E5%BD%A2%E7%A0%81%E4%BF%9D%E5%AF%86%E5%8F%8A%E5%AE%B9%E9%94%99%E6%8A%80%E6%9C%AF/">基于门限方案的条形码保密及容错技术</a>
          </li>
        
          <li>
            <a href="/2020/04/23/%E5%A4%9A%E5%AA%92%E4%BD%93%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C-%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E3%80%81%E6%BB%A4%E6%B3%A2%E4%BB%A5%E5%8F%8A%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C/">多媒体第三次选做实验-图像处理、滤波以及动画效果</a>
          </li>
        
          <li>
            <a href="/2020/04/17/%E5%9F%BA%E4%BA%8Ewin32-GDI%E7%9A%84%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%B3%95%E9%80%89%E5%81%9A%E5%AE%9E%E9%AA%8C%E7%AC%94%E8%AE%B0/">基于win32 GDI的图像显示方法选做实验笔记</a>
          </li>
        
          <li>
            <a href="/2020/04/15/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E7%89%A9%E6%B5%81%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/">基于CRT的物流信息安全处理方案</a>
          </li>
        
          <li>
            <a href="/2020/04/13/%E5%9F%BA%E4%BA%8ECRT%E7%9A%84%E6%96%B0%E5%9E%8B%E7%BE%A4%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E7%B3%BB%E7%BB%9F/">基于CRT的新型群文件共享系统</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 life-extension<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>